<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teachy Witchy — Book Viewer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<style>
  /* Прозрачный фон, жесты не мешают кликам */
  html,body{margin:0;height:100%;background:transparent;overflow:hidden;touch-action:manipulation;-webkit-tap-highlight-color:transparent}

  /* Сцена + «воздух» вокруг (чтобы волна не резалась) */
  :root{ --padX:0px; --padY:0px; }
  .scene{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:transparent;overflow:visible}
  .pad{position:relative;display:flex;align-items:center;justify-content:center;padding:var(--padY) var(--padX);background:transparent;overflow:visible}

  /* Книга натурального размера (2*w × h), масштабируем целиком */
  .book-frame{position:relative;transform-origin:center center;will-change:transform}
  #book{width:100%;height:100%;background:transparent}

  /* Сброс лишних теней/рамок библиотеки — НИЧЕГО поверх кликов не кладём */
  .stf__wrapper,.stf__block,.stf__item,.stf__page,.stf__content{
    background:transparent!important;margin:0!important;padding:0!important;border:0!important;box-shadow:none!important;
  }
  .stf__page{overflow:hidden}

  /* Страница = картинка, без деформаций и обрезания */
  .page{width:100%;height:100%;position:relative}
  .page img{width:100%;height:100%;object-fit:contain;display:block;user-select:none;-webkit-user-drag:none;pointer-events:none}

  /* Нежные виньетки по краям (как в твоей рабочей) */
  .stf__item--left::after, .stf__item--right::after{
    content:""; position:absolute; inset:0; pointer-events:none; mix-blend-mode:multiply;
  }
  .stf__item--left::after { background:linear-gradient(90deg, rgba(0,0,0,.22) 0%, rgba(0,0,0,0) 14%) }
  .stf__item--right::after{ background:linear-gradient(270deg, rgba(0,0,0,.22) 0%, rgba(0,0,0,0) 14%) }

  /* Тень у корешка внутри */
  .stf__item--left::before, .stf__item--right::before{
    content:""; position:absolute; top:0; bottom:0; width:3%; pointer-events:none; mix-blend-mode:multiply; opacity:.4;
  }
  .stf__item--left::before { right:0; background:linear-gradient(90deg, rgba(0,0,0,.6), rgba(0,0,0,0)) }
  .stf__item--right::before{ left:0;  background:linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,.6)) }

  /* Периметрная тень «книга на столе» — через drop-shadow САМОЙ страницы */
  .stf__item{
    filter: drop-shadow(0 18px 22px rgba(0,0,0,.28))
            drop-shadow(0 4px 10px rgba(0,0,0,.20));
  }
  /* Чуть мягче, если показывается одиночная страница (обложка/задник) */
  .book-frame.single .stf__item{
    filter: drop-shadow(0 14px 18px rgba(0,0,0,.22))
            drop-shadow(0 2px 8px rgba(0,0,0,.16));
  }

  /* Сообщение об ошибке (не мешает кликам) */
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);color:#fff;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;z-index:99999;pointer-events:none}
  .overlay.show{display:flex}
  .overlay .panel{background:#121212;border:1px solid #333;border-radius:12px;padding:12px 14px;max-width:720px}
</style>
</head>
<body>
  <div id="scene" class="scene">
    <div id="pad" class="pad">
      <div id="frame" class="book-frame">
        <div id="book"></div>
      </div>
    </div>
    <div id="ovl" class="overlay"><div class="panel" id="ovlMsg">Ошибка</div></div>
  </div>

  <audio id="flipSound" preload="auto" src="https://raw.githubusercontent.com/NikaShum93/bookflip/main/flip.mp3"></audio>
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
  <script>
  (function(){
    const qs   = new URLSearchParams(location.search);
    const urls = (qs.get('imgs')||'').split(/[|,]/).map(s=>s.trim()).filter(Boolean).map(s=>{try{return decodeURIComponent(s)}catch{return s}});
    if(!urls.length) return err('Пустой imgs — нет изображений.');

    const flipTime = +qs.get('flipTime')>0 ? +qs.get('flipTime') : 800;
    const showHint = (qs.get('showHint')||'false') === 'true';
    const soundOn  = (qs.get('sound')||'1') === '1';

    let pageW = parseInt(qs.get('w'),10) || 600;
    let pageH = parseInt(qs.get('h'),10) || 900;

    const scene  = document.getElementById('scene');
    const padEl  = document.getElementById('pad');
    const frame  = document.getElementById('frame');
    const bookEl = document.getElementById('book');

    /* Воздух (не режем волну): ~16% по ширине, ~22% по высоте */
    const padX = Math.round(pageW * 0.16);
    const padY = Math.round(pageH * 0.22);
    padEl.style.setProperty('--padX', padX + 'px');
    padEl.style.setProperty('--padY', padY + 'px');

    /* Рамка 2w × h и масштаб с учётом «воздуха» */
    function setFrameSize(){ frame.style.width=(pageW*2)+'px'; frame.style.height=pageH+'px'; fitToScene(); }
    function fitToScene(){
      const availW=scene.clientWidth, availH=scene.clientHeight;
      const needW = pageW*2 + padX*2, needH = pageH + padY*2;
      const scale = Math.min(availW/needW, availH/needH);
      frame.style.transform='scale('+scale+')';
    }
    setFrameSize();
    addEventListener('resize', fitToScene, {passive:true});

    /* Инициализация */
    const pf = new St.PageFlip(bookEl,{
      width:pageW, height:pageH, size:'fixed', autoSize:false,
      showCover:true, usePortrait:false,
      flippingTime:flipTime, maxShadowOpacity:0.85, drawShadow:true,
      mobileScrollSupport:true, useMouseEvents:true, clickEventForward:false,
      showHint:showHint
    });

    /* Страницы */
    const host=document.createElement('div');
    urls.forEach((src,i)=>{
      const p=document.createElement('div'); p.className='page';
      p.setAttribute('data-density',(i===0||i===urls.length-1)?'hard':'soft');
      const img=document.createElement('img'); img.src=src; img.alt='';
      p.appendChild(img); host.appendChild(p);
    });
    const nodes=host.querySelectorAll('.page');
    if(typeof pf.loadFromHTML==='function') pf.loadFromHTML(nodes); else pf.loadFromImages(urls);

    /* Одиночка для обложки/задника — чтобы слева у обложки не было «спутника» */
    function syncSingle(){
      const i=pf.getCurrentPageIndex();
      frame.classList.toggle('single', (i===0||i===urls.length-1));
    }
    syncSingle(); pf.on('flip', syncSingle);

    /* Звук */
    const flipSound=document.getElementById('flipSound');
    pf.on('flip',()=>{ if(!soundOn) return; try{ flipSound.currentTime=0; flipSound.play(); }catch(e){} });

    /* Стабильные клики (ровно как в рабочей версии) */
    let lock=false;
    function safeFlip(dir){
      if(lock||pf.isFlipping()) return;
      lock=true;
      (dir==='prev')?pf.flipPrev('top'):pf.flipNext('top');
      setTimeout(()=>lock=false, pf.getSettings().flippingTime+40);
    }
    scene.addEventListener('click', (e)=>{
      const r=scene.getBoundingClientRect();
      const x=e.clientX-r.left;
      safeFlip(x<r.width/2?'prev':'next');
    }, {passive:true});

    addEventListener('keydown', (e)=>{
      if(e.key==='ArrowLeft')  safeFlip('prev');
      if(e.key==='ArrowRight') safeFlip('next');
    });

    function err(msg){ const o=document.getElementById('ovl'), m=document.getElementById('ovlMsg'); m.textContent=msg; o.classList.add('show'); }
  })();
  </script>
</body>
</html>
