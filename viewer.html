<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teachy Witchy — Живая книга</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<style>
  html,body{margin:0;height:100%;background:transparent;overflow:hidden}

  /* сцена без перекрытий и посторонних слоёв */
  .scene{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:transparent; overflow:visible; pointer-events:auto; touch-action:none;
  }

  /* книга 2w×h — масштабируем, чтобы волна не резалась, но без паддингов/рамок */
  .book-frame{
    position:relative; background:transparent; overflow:visible;
    transform-origin:center center; will-change:transform; pointer-events:auto;
  }
  #book{ width:100%; height:100%; background:transparent }
  .stf__wrapper,.stf__block{ overflow:visible !important; touch-action:none !important; }

  /* Страница: контент + тени слиты на самой странице */
  .page{ position:relative; width:100%; height:100%; background:transparent; }
  .page img{
    width:100%; height:100%; object-fit:contain; display:block;
    background:transparent; border:none; border-radius:0; box-shadow:none; outline:none;
    user-select:none; -webkit-user-drag:none; pointer-events:none;
  }

  /* Внутренняя виньетка поля (едет вместе с листом) */
  .page::after{
    content:""; position:absolute; inset:0; pointer-events:none; z-index:2; mix-blend-mode:multiply;
    background:
      radial-gradient(110% 95% at 50% 50%, rgba(0,0,0,.14) 0%, rgba(0,0,0,0) 60%),
      linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,0) 18%, rgba(0,0,0,0) 82%, rgba(0,0,0,.06));
  }

  /* Кромки страницы */
  :root{ --edge:14px; }
  .page::before{
    content:""; position:absolute; top:0; bottom:0; left:0; width:var(--edge);
    pointer-events:none; z-index:2; mix-blend-mode:multiply; opacity:.55;
    background:linear-gradient(90deg, rgba(0,0,0,.24), rgba(0,0,0,0));
  }
  .page > i.edge{
    position:absolute; top:0; bottom:0; right:0; width:var(--edge);
    pointer-events:none; z-index:2; mix-blend-mode:multiply; opacity:.55;
    background:linear-gradient(270deg, rgba(0,0,0,.24), rgba(0,0,0,0));
  }

  /* Корешок и внешние края разворота (сидят на item, но не перекрывают клики) */
  .stf__item{ pointer-events:none; }      /* <-- не крадём события */
  .stf__item--left::after,
  .stf__item--right::after{
    content:""; position:absolute; inset:0; z-index:1; pointer-events:none; mix-blend-mode:multiply;
  }
  .stf__item--left::after  { background:linear-gradient(90deg,  rgba(0,0,0,.35) 0%, rgba(0,0,0,0) 20%); }
  .stf__item--right::after { background:linear-gradient(270deg, rgba(0,0,0,.35) 0%, rgba(0,0,0,0) 20%); }
  .stf__item--left::before,
  .stf__item--right::before{
    content:""; position:absolute; top:0; bottom:0; width:3.2%; opacity:.45; z-index:1; pointer-events:none; mix-blend-mode:multiply;
  }
  .stf__item--left::before  { right:0; background:linear-gradient(90deg, rgba(0,0,0,.55), rgba(0,0,0,0)); }
  .stf__item--right::before { left:0;  background:linear-gradient(270deg, rgba(0,0,0,.55), rgba(0,0,0,0)); }

  /* Немного «загнутые» уголки (в перспективе) — на самой странице */
  .page > em.corner{
    position:absolute; width:22%; height:22%; pointer-events:none; z-index:3; mix-blend-mode:multiply;
    background:radial-gradient(100% 100% at 100% 0%, rgba(0,0,0,.34) 0%, rgba(0,0,0,.16) 40%, rgba(0,0,0,0) 72%);
    transform:skewX(-6deg) rotate(-1.2deg); filter:blur(.4px);
  }
  .page > em.corner.lt{ left:-2%; top:-2%; transform-origin:left top; opacity:.22; }
  .page > em.corner.rb{ right:-2%; bottom:-2%; transform-origin:right bottom; opacity:.30; }

  /* На обложке/заднике корешковые градиенты не нужны */
  .single .stf__item::before,
  .single .stf__item::after{ display:none; }

  /* Оверлей ошибок */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);color:#fff;z-index:9}
  .overlay.show{display:flex}
  .panel{background:#121212;border:1px solid #333;border-radius:12px;padding:12px 14px}
</style>
</head>
<body>
  <div id="scene" class="scene">
    <div id="frame" class="book-frame">
      <div id="book"></div>
    </div>
    <div id="ovl" class="overlay"><div id="ovlMsg" class="panel">Ошибка</div></div>
  </div>

  <audio id="flipSound" preload="auto" src="https://raw.githubusercontent.com/NikaShum93/bookflip/main/flip.mp3"></audio>
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
  <script>
  (function(){
    const qs=new URLSearchParams(location.search);
    const urls=(qs.get('imgs')||'').split(/[|,]/).map(s=>{s=s.trim();try{return decodeURIComponent(s)}catch{return s}}).filter(Boolean);
    if(!urls.length){ return err('Пустой imgs — нет изображений.'); }

    const flipTime = +qs.get('flipTime')>0 ? +qs.get('flipTime') : 800;
    const pageW = parseInt(qs.get('w'),10)||600;
    const pageH = parseInt(qs.get('h'),10)||900;

    const scene = document.getElementById('scene');
    const frame = document.getElementById('frame');
    const book  = document.getElementById('book');

    /* Масштабируем без паддингов/рамок: только безопасный запас вне книги */
    const safeX = 0.18, safeY = 0.22;
    frame.style.width  = (pageW*2) + 'px';
    frame.style.height =  pageH    + 'px';

    function fit(){
      const needW=(pageW*2)*(1+safeX*2), needH=pageH*(1+safeY*2);
      const s=Math.min(scene.clientWidth/needW, scene.clientHeight/needH);
      frame.style.transform='scale('+s+')';
    }
    addEventListener('resize', fit, {passive:true}); fit();

    /* PageFlip — ни один верхний слой не крадёт клики/свайпы */
    const pf = new St.PageFlip(book,{
      width:pageW, height:pageH, size:'fixed', autoSize:false,
      usePortrait:false, showCover:true,
      flippingTime:flipTime, drawShadow:true, maxShadowOpacity:.9,
      mobileScrollSupport:false, /* важно для Genially */
      showHint:false
    });

    /* Страницы: добавляем «edge» и «corner» элементы внутрь .page */
    const host=document.createElement('div');
    urls.forEach((src,i)=>{
      const p=document.createElement('div'); p.className='page';
      p.setAttribute('data-density', (i===0||i===urls.length-1)?'hard':'soft');
      const img=document.createElement('img'); img.src=src; img.alt='';
      const edge=document.createElement('i'); edge.className='edge';
      const c1=document.createElement('em'); c1.className='corner lt';
      const c2=document.createElement('em'); c2.className='corner rb';
      p.append(img, edge, c1, c2);
      host.appendChild(p);
    });
    if(typeof pf.loadFromHTML==='function') pf.loadFromHTML(host.children); else pf.loadFromImages(urls);

    /* Управление: клики по самой книге (а не по всей сцене) — надёжнее в Genially */
    let lock=false;
    function safeFlip(dir){
      if(lock||pf.isFlipping()) return;
      lock=true;
      (dir==='prev'?pf.flipPrev:pf.flipNext).call(pf,'top');
      setTimeout(()=>lock=false, pf.getSettings().flippingTime+40);
    }
    // Клик: левая/правая половина кадра книги
    frame.addEventListener('click', e=>{
      const r=frame.getBoundingClientRect();
      const x=e.clientX-r.left;
      safeFlip( x<r.width/2 ? 'prev' : 'next' );
    }, {passive:true});

    // Свайпы внутри iFrame (иногда Genially их перехватывает — поэтому touch-action:none выше)
    let startX=0, dx=0;
    frame.addEventListener('touchstart', e=>{ if(e.touches&&e.touches[0]) startX=e.touches[0].clientX; }, {passive:true});
    frame.addEventListener('touchmove',  e=>{ if(e.touches&&e.touches[0]) dx=e.touches[0].clientX-startX; }, {passive:true});
    frame.addEventListener('touchend',   ()=>{ if(Math.abs(dx)>24) safeFlip(dx>0?'prev':'next'); startX=0; dx=0; }, {passive:true});

    // Звук + класс single для отключения корешковых теней на обложке/заднике
    const flipSound=document.getElementById('flipSound');
    function syncSingle(){
      const i=pf.getCurrentPageIndex();
      frame.classList.toggle('single', (i===0||i===urls.length-1));
    }
    pf.on('flip', ()=>{ try{ flipSound.currentTime=0; flipSound.play(); }catch(e){} syncSingle(); });
    syncSingle();

    function err(msg){const o=document.getElementById('ovl'),m=document.getElementById('ovlMsg');m.textContent=msg;o.classList.add('show');}
  })();
  </script>
</body>
</html>
