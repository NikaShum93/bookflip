<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BookFlip Viewer — hard cover, transparent</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<noscript><link rel="stylesheet" href="https://unpkg.com/page-flip@2.0.7/dist/css/page-flip.min.css"></noscript>

<style>
  :root{ --depth:.35; --edge:.22; }
  html,body{height:100%;margin:0;background:transparent}
  /* вместо vw/vh — строго 100% iframe */
  .wrap{position:absolute; inset:0; display:grid; place-items:center; background:transparent}
  .book{position:relative; width:100%; height:100%; background:transparent}
  #flip{position:absolute; inset:0; background:transparent}

  /* объёмные тени */
  .book::after{
    content:""; position:absolute; left:6%; right:6%; bottom:-12px; height:28px;
    filter: blur(10px);
    background: radial-gradient(60% 100% at 50% 0%,
      rgba(0,0,0,calc(.9*var(--depth))) 0%,
      rgba(0,0,0,0) 70%);
    pointer-events:none;
  }
  /* корешковая тень только когда разворот двойной */
  #flip::before{
    content:""; position:absolute; top:2.5%; bottom:2.5%; left:50%; width:56px; transform:translateX(-50%);
    pointer-events:none;
    background: linear-gradient(90deg,
      rgba(0,0,0,0) 0%,
      rgba(0,0,0,calc(.85*var(--depth))) 50%,
      rgba(0,0,0,0) 100%);
    filter: blur(10px);
    opacity:.9;
  }
  #flip.single::before{ display:none; } /* на обложке/последней — без корешка */

  /* лёгкая виньетка по краям страниц */
  .stf__item::after{
    content:""; position:absolute; inset:0; pointer-events:none; mix-blend-mode:multiply;
    background: linear-gradient(90deg,
      rgba(0,0,0,calc(var(--edge))) 0%,
      rgba(0,0,0,0) 18%,
      rgba(0,0,0,0) 82%,
      rgba(0,0,0,calc(var(--edge))) 100%);
  }

  /* страница-обёртка для IMG */
  .page{display:grid; place-items:center; width:100%; height:100%; background:transparent}
  .page img{
    width:100%; height:100%;
    object-fit:contain;        /* не растягиваем! */
    display:block;
    user-select:none; -webkit-user-drag:none;
  }

  /* Оверлей ошибок (показывается только при проблемах) */
  .overlay{position:absolute; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.25); color:#fff; font:14px/1.4 system-ui,Segoe UI,Roboto,Arial; z-index:9999}
  .overlay.show{ display:flex; }
  .overlay .panel{background:#121212;border:1px solid #333;border-radius:12px;padding:16px 18px;max-width:720px}
  .overlay .list{max-height:220px;overflow:auto;margin-top:8px;font-family:ui-monospace,Consolas,monospace;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="book"><div id="flip"></div></div>
  <div id="ovl" class="overlay"><div class="panel">
    <div id="ovlTitle">Ошибка</div>
    <div id="ovlBody" class="list"></div>
  </div></div>
</div>

<script>
(function(){
  // ===== helpers =====
  const ovl = document.getElementById('ovl');
  const t = document.getElementById('ovlTitle');
  const b = document.getElementById('ovlBody');
  function showError(msg, list){ t.textContent=msg; b.innerHTML=(list||[]).map(x=>`<div>${x}</div>`).join(''); ovl.classList.add('show'); }
  function hideError(){ ovl.classList.remove('show'); }

  // ===== params =====
  const q = new URLSearchParams(location.search);
  const rawImgs = (q.get('imgs')||'').split(/[|,]/).map(s=>s.trim()).filter(Boolean).map(s=>{try{return decodeURIComponent(s)}catch{return s}});
  const flipTime = Number(String(q.get('flipTime')||'').replace(',', '.')) || 800;
  const tilt     = Number(String(q.get('tilt')||'').replace(',', '.')) || 2;
  const showHint = (q.get('showHint')||'false') === 'true';

  const sfxUrl = "https://raw.githubusercontent.com/NikaShum93/bookflip/main/flip.mp3";

  const fallbacks = [
    "https://images.unsplash.com/photo-1514511542842-209a87b229c6?q=80&w=1200&auto=format&fit=crop",
    "https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?q=80&w=1200&auto=format&fit=crop",
    "https://images.unsplash.com/photo-1529336953121-adb2f3f1c6b6?q=80&w=1200&auto=format&fit=crop"
  ];
  const imgUrls = rawImgs.length ? rawImgs : fallbacks;

  // ===== preload imgs (без отображения “загрузка...”) =====
  Promise.all(imgUrls.map(src=>new Promise(res=>{
    const im=new Image();
    im.onload = ()=>res({ok:true,src});
    im.onerror= ()=>res({ok:false,src});
    im.src = src;
  }))).then(rs=>{
    const bad = rs.filter(r=>!r.ok).map(r=>r.src);
    const ok  = rs.filter(r=>r.ok).map(r=>r.src);
    if (!ok.length){ showError('Нет ни одного доступного изображения. Проверь ссылки.'); return; }
    if (bad.length){ showError('Часть изображений не загрузилась. Остальные откроются.', bad); setTimeout(hideError, 2500); }
    return loadScript('https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js')
      .catch(()=>loadScript('https://unpkg.com/page-flip@2.0.7/dist/js/page-flip.browser.min.js'))
      .then(()=>ok);
  }).then(okUrls=>{
    if (!okUrls) return;
    if (!(window.St && window.St.PageFlip)){ showError('Ошибка инициализации книги: St is not defined'); return; }
    init(okUrls);
  }).catch(e=>showError('Ошибка: ' + (e && e.message ? e.message : e)));

  function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=()=>res(); s.onerror=()=>rej(new Error('Не удалось загрузить '+src)); document.head.appendChild(s); }); }

  function makePage(src, density){
    const p = document.createElement('div');
    p.className = 'page';
    if (density) p.setAttribute('data-density', density); // 'hard' или 'soft'
    const img = document.createElement('img');
    img.src = src;
    img.alt = '';
    img.draggable = false;
    p.appendChild(img);
    return p;
  }

  function init(pages){
    try{
      const flipRoot = document.getElementById('flip');
      const r = flipRoot.getBoundingClientRect();
      let pageWidth  = Math.max(220, Math.floor((r.width||800)/2));
      let pageHeight = Math.max(220, Math.floor(r.height||600));

      const pf = new St.PageFlip(flipRoot, {
        width: pageWidth,
        height: pageHeight,
        size: 'stretch',
        minWidth: 180, minHeight: 180,
        maxShadowOpacity: 0.25,
        flippingTime: flipTime,
        showHint: showHint,
        usePortrait: false,
        showCover: true,      // обложка показывается одна
        startPage: 0,
        autoSize: true,
        clickEventForward: true,
        mobileScrollSupport: true,
        drawShadow: true
      });

      // строим DOM: первая и последняя — жёсткие
      const htmlPages = pages.map((src, i)=> {
        const density = (i===0 || i===pages.length-1) ? 'hard' : 'soft';
        return makePage(src, density);
      });

      if (typeof pf.loadFromHTML === 'function') pf.loadFromHTML(htmlPages);
      else pf.loadFromImages(pages);

      // “почти прямо”
      const root = flipRoot.closest('.book');
      if (root) root.style.transform = `rotateX(${tilt}deg)`;

      // звук
      let sfx=null; try{ sfx=new Audio(sfxUrl); sfx.preload='auto'; }catch(e){}
      pf.on('flip', ()=>{ if(sfx){ sfx.currentTime=0; sfx.play().catch(()=>{}); } });

      // показывать/скрывать корешковую тень на обложке/последней
      function updateCenterShadow(){
        const single = (pf.getCurrentPageIndex() === 0) || (pf.getCurrentPageIndex() === pages.length-1);
        flipRoot.classList.toggle('single', single);
      }
      updateCenterShadow();
      pf.on('flip', updateCenterShadow);

      // клавиши
      window.addEventListener('keydown', e=>{
        if (e.key==='ArrowRight') pf.flipNext('bottom');
        else if (e.key==='ArrowLeft') pf.flipPrev('bottom');
      });

      // ресайз
      window.addEventListener('resize', ()=>{
        const rr = flipRoot.getBoundingClientRect();
        pf.update({ width: Math.max(220, Math.floor((rr.width||800)/2)),
                    height: Math.max(220, Math.floor(rr.height||600)) });
      });

      hideError(); // на всякий
    }catch(e){
      showError('Ошибка инициализации книги: ' + (e && e.message ? e.message : e));
    }
  }
})();
</script>
</body>
</html>
