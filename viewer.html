<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teachy Witchy — Book Viewer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<style>
  html,body{margin:0;height:100%;background:transparent;overflow:hidden;touch-action:manipulation}
  .scene{position:relative;width:100%;height:100%;background:transparent;display:flex;align-items:center;justify-content:center}
  .book-frame{position:relative;transform-origin:center center;will-change:transform}
  #book{width:100%;height:100%;background:transparent}

  /* Ничего не режем внутри виджета */
  .stf__wrapper,.stf__block,.stf__page,.stf__item,.stf__content{overflow:visible!important;background:transparent!important}

  /* Страница — просто картинка без деформации */
  .page{width:100%;height:100%;position:relative}
  .page img{width:100%;height:100%;object-fit:contain;display:block;user-select:none;-webkit-user-drag:none;pointer-events:none}

  /* (опционально) мягкая тень под всей книгой — не мешает кликам */
  /* .book-frame::after{content:"";position:absolute;inset:auto 6% -18px 6%;height:36px;pointer-events:none;filter:blur(10px);
    background:radial-gradient(60% 100% at 50% 0%,rgba(0,0,0,.35) 0%,rgba(0,0,0,.2) 45%,rgba(0,0,0,.08) 75%,rgba(0,0,0,0) 100%);} */
</style>
</head>
<body>
  <div id="scene" class="scene">
    <div id="frame" class="book-frame"><div id="book"></div></div>
  </div>

  <audio id="flipSound" preload="auto" src="https://raw.githubusercontent.com/NikaShum93/bookflip/main/flip.mp3"></audio>
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
  <script>
  (function(){
    const qs = new URLSearchParams(location.search);

    // двойное декодирование imgs (на случай %253A)
    const raw = (qs.get('imgs')||'').split(/[|,]/).map(s=>s.trim()).filter(Boolean);
    const urls = raw.map(s=>{try{return decodeURIComponent(decodeURIComponent(s))}catch(_){try{return decodeURIComponent(s)}catch(_){return s}}})
                    .filter(Boolean);
    if(!urls.length){ console.error('Пустой imgs'); return; }

    const flipTime = +qs.get('flipTime')>0?+qs.get('flipTime'):800;

    // натуральный размер одной страницы
    const pageW = parseInt(qs.get('w'),10)||600;
    const pageH = parseInt(qs.get('h'),10)||900;

    // "воздух" для волны (чтобы не обрезало) – можно подрегулировать
    const padX = Math.round(pageW*0.14);
    const padY = Math.round(pageH*0.18);

    const scene = document.getElementById('scene');
    const frame = document.getElementById('frame');
    const bookEl = document.getElementById('book');

    // рамка книги ровно 2w × h
    frame.style.width  = (pageW*2)+'px';
    frame.style.height =  pageH    +'px';

    function fit(){
      const availW = scene.clientWidth;
      const availH = scene.clientHeight;
      const needW  = pageW*2 + padX*2;   // учитываем воздух
      const needH  = pageH    + padY*2;
      const s = Math.min(availW/needW, availH/needH);
      frame.style.transform = 'scale('+s+')';
    }
    addEventListener('resize', fit, {passive:true}); fit();

    // Инициализация PageFlip
    const pf = new St.PageFlip(bookEl, {
      width: pageW, height: pageH,
      size:'fixed', autoSize:false,
      usePortrait:false, showCover:true,
      flippingTime: flipTime,
      drawShadow:true, maxShadowOpacity:.85,
      mobileScrollSupport:true,
      useMouseEvents:true,
      clickEventForward:false,
      showHint:false
    });

    // Страницы
    const host = document.createElement('div');
    urls.forEach((src,i)=>{
      const p = document.createElement('div'); p.className='page';
      p.setAttribute('data-density', (i===0||i===urls.length-1)?'hard':'soft');
      const img = document.createElement('img'); img.src=src; img.alt='';
      p.appendChild(img); host.appendChild(p);
    });
    const nodes = host.querySelectorAll('.page');
    if(typeof pf.loadFromHTML==='function') pf.loadFromHTML(nodes); else pf.loadFromImages(urls);

    // Звук
    const flipSound=document.getElementById('flipSound');
    pf.on('flip', ()=>{ try{ flipSound.currentTime=0; flipSound.play(); }catch(e){} });

    // Листание: клики по книге + «страховка» на window (capture) — важно для Genially
    let lock=false;
    function go(dir){
      if(lock||pf.isFlipping()) return;
      lock=true;
      (dir==='prev')?pf.flipPrev('top'):pf.flipNext('top');
      setTimeout(()=>lock=false, pf.getSettings().flippingTime+50);
    }

    // основной обработчик — на самой книге
    bookEl.addEventListener('pointerdown', (e)=>{
      const r = frame.getBoundingClientRect();
      const x = (e.clientX||0)-r.left;
      go(x<r.width/2?'prev':'next');
      e.preventDefault();
    }, {passive:false});

    // страховка (если родитель «ест» события)
    window.addEventListener('pointerdown', (e)=>{
      if(!e.target.closest('#book')) return;
      const r = frame.getBoundingClientRect();
      const x = (e.clientX||0)-r.left;
      go(x<r.width/2?'prev':'next');
      e.preventDefault();
    }, {passive:false, capture:true});

    // ещё клавиатура — на всякий случай
    window.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowLeft')  go('prev');
      if(e.key==='ArrowRight') go('next');
    });
  })();
  </script>
</body>
</html>
