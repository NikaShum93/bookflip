<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teachy Witchy — Book Viewer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<style>
  html,body{margin:0;height:100%;background:transparent;overflow:hidden}

  /* сцена и «воздух» вокруг книги */
  .scene{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:transparent;overflow:visible}
  :root{--padX:0px;--padY:0px}
  .pad{position:relative;width:100%;height:100%;padding:var(--padY) var(--padX);box-sizing:border-box;display:flex;align-items:center;justify-content:center;overflow:visible}

  /* рамка натурального размера 2w×h — масштабируем её */
  .book-frame{position:relative;transform-origin:center center;will-change:transform;overflow:visible}

  /* ТЕНЬ ПОД КНИГОЙ (по периметру), очень деликатная */
  .book-frame::before{
    content:""; position:absolute; inset:0; z-index:0; pointer-events:none;
    /* прям «лежит на столе», без бурого ореола */
    box-shadow:
      0 22px 28px rgba(0,0,0,.20),
      0 8px 16px  rgba(0,0,0,.12),
      0 0 1px    rgba(0,0,0,.22);
  }

  #book{width:100%;height:100%;background:transparent}
  .stf__wrapper,.stf__block{overflow:visible!important;background:transparent!important}

  /* страницы — чистые картинки, не деформируем */
  .page{position:relative;width:100%;height:100%;background:transparent}
  .page img{width:100%;height:100%;object-fit:contain;display:block;user-select:none;-webkit-user-drag:none;pointer-events:none}

  /* Узкая тень у корешка на развороте */
  .stf__item--left::before,.stf__item--right::before{
    content:""; position:absolute; top:0; bottom:0; width:3%;
    pointer-events:none; mix-blend-mode:multiply; opacity:.40; z-index:1;
    background:linear-gradient(90deg, rgba(0,0,0,.60), rgba(0,0,0,0));
  }
  .stf__item--right::before{ left:0; transform:scaleX(-1); transform-origin:left }

  /* лёгкая внешняя виньетка у ДАЛЬНИХ краёв разворота */
  .stf__item--left::after,.stf__item--right::after{
    content:""; position:absolute; inset:0; pointer-events:none; mix-blend-mode:multiply; opacity:.20; z-index:1;
  }
  .stf__item--left::after  { background:linear-gradient(90deg, rgba(0,0,0,.14) 0%, rgba(0,0,0,0) 14%) }
  .stf__item--right::after { background:linear-gradient(90deg, rgba(0,0,0,0) 86%, rgba(0,0,0,.14) 100%) }

  /* на обложке слева тени нет */
  .single .stf__item::before{display:none}
  .single .stf__item--left::after,.single .stf__item--right::after{background:none}

  /* чуть «помятые» ВНЕШНИЕ уголки, не у корешка */
  .stf__item--left  .page::after,
  .stf__item--right .page::after{
    content:""; position:absolute; inset:0; pointer-events:none; opacity:.28; mix-blend-mode:multiply;
  }
  .stf__item--left  .page::after{
    background:
      radial-gradient(26% 26% at 0% 0%,   rgba(0,0,0,.18) 0%, rgba(0,0,0,0) 60%) top left / 46% 46% no-repeat,
      radial-gradient(26% 26% at 0% 100%, rgba(0,0,0,.18) 0%, rgba(0,0,0,0) 60%) bottom left / 46% 46% no-repeat;
  }
  .stf__item--right .page::after{
    background:
      radial-gradient(26% 26% at 100% 0%,  rgba(0,0,0,.18) 0%, rgba(0,0,0,0) 60%) top right / 46% 46% no-repeat,
      radial-gradient(26% 26% at 100% 100%,rgba(0,0,0,.18) 0%, rgba(0,0,0,0) 60%) bottom right / 46% 46% no-repeat;
  }

  /* оверлей ошибок */
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);color:#fff;z-index:9999}
  .overlay.show{display:flex}
  .overlay .panel{background:#121212;border:1px solid #333;border-radius:12px;padding:12px 14px;max-width:720px}
</style>
</head>
<body>
  <div id="scene" class="scene">
    <div class="pad">
      <div id="frame" class="book-frame">
        <div id="book"></div>
      </div>
    </div>
    <div id="ovl" class="overlay"><div class="panel" id="ovlMsg">Ошибка</div></div>
  </div>

  <audio id="flipSound" preload="auto" src="https://raw.githubusercontent.com/NikaShum93/bookflip/main/flip.mp3"></audio>
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
  <script>
  (function(){
    const qs=new URLSearchParams(location.search);
    const urls=(qs.get('imgs')||'').split(/[|,]/).map(s=>s.trim()).filter(Boolean).map(s=>{try{return decodeURIComponent(s)}catch{return s}});
    if(!urls.length) return err('Пустой imgs — нет изображений.');

    const flipTime=+qs.get('flipTime')>0?+qs.get('flipTime'):800;
    const pageW=parseInt(qs.get('w'),10)||600;
    const pageH=parseInt(qs.get('h'),10)||900;

    const scene=document.getElementById('scene');
    const padBox=document.querySelector('.pad');
    const frame=document.getElementById('frame');
    const book=document.getElementById('book');

    /* воздух по краям — чтобы волна не обрезалась */
    const padX=Math.round(pageW*0.14);
    const padY=Math.round(pageH*0.18);
    padBox.style.setProperty('--padX',padX+'px');
    padBox.style.setProperty('--padY',padY+'px');

    function setSize(){
      frame.style.width=(pageW*2)+'px';
      frame.style.height=pageH+'px';
      fit();
    }
    function fit(){
      const needW=pageW*2+padX*2, needH=pageH+padY*2;
      const s=Math.min(scene.clientWidth/needW, scene.clientHeight/needH);
      frame.style.transform='scale('+s+')';
    }
    setSize(); addEventListener('resize',fit,{passive:true});

    /* PageFlip — настройки из твоего рабочего варианта */
    const pf=new St.PageFlip(book,{
      width:pageW,height:pageH,size:'fixed',autoSize:false,
      showCover:true,usePortrait:false,
      flippingTime:flipTime,maxShadowOpacity:.85,drawShadow:true,
      mobileScrollSupport:true,useMouseEvents:true,clickEventForward:false,showHint:false
    });

    /* страницы */
    const host=document.createElement('div');
    urls.forEach((src,i)=>{
      const p=document.createElement('div'); p.className='page';
      p.setAttribute('data-density',(i===0||i===urls.length-1)?'hard':'soft');
      const img=document.createElement('img'); img.src=src; img.alt='';
      p.appendChild(img); host.appendChild(p);
    });
    const nodes=host.querySelectorAll('.page');
    if(typeof pf.loadFromHTML==='function') pf.loadFromHTML(nodes); else pf.loadFromImages(urls);

    /* отключаем «левую» тень, когда книга закрыта */
    function syncSingle(){
      const i=pf.getCurrentPageIndex();
      frame.classList.toggle('single',(i===0||i===urls.length-1));
    }
    syncSingle(); pf.on('flip',syncSingle);

    /* звук и клики — по сцене слева/справа */
    const flipSound=document.getElementById('flipSound');
    pf.on('flip',()=>{ try{flipSound.currentTime=0; flipSound.play();}catch(e){} });

    let lock=false;
    function safeFlip(dir){
      if(lock||pf.isFlipping()) return;
      lock=true; (dir==='prev')?pf.flipPrev('top'):pf.flipNext('top');
      setTimeout(()=>lock=false, pf.getSettings().flippingTime+40);
    }
    scene.addEventListener('click',e=>{
      const r=scene.getBoundingClientRect();
      safeFlip((e.clientX-r.left)<r.width/2?'prev':'next');
    }, {passive:true});
    addEventListener('keydown',e=>{
      if(e.key==='ArrowLeft')  safeFlip('prev');
      if(e.key==='ArrowRight') safeFlip('next');
    }, {passive:true});

    function err(msg){const o=document.getElementById('ovl'),m=document.getElementById('ovlMsg');m.textContent=msg;o.classList.add('show')}
  })();
  </script>
</body>
</html>
