<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teachy Witchy — Book Viewer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<style>
  html,body{margin:0;height:100%;background:transparent;overflow:hidden}
  .scene{position:relative;width:100%;height:100%;background:transparent;display:flex;align-items:center;justify-content:center;touch-action:none}

  /* рамка натурального размера 2*w × h, на неё вешаем scale */
  .book-frame{position:relative;transform-origin:center center;will-change:transform}

  /* мягкая «подложка» под книгой (не под рамкой) */
  .book-frame::after{
    content:"";position:absolute;left:6%;right:6%;bottom:-18px;height:36px;pointer-events:none;filter:blur(10px);
    background:radial-gradient(60% 100% at 50% 0%,rgba(0,0,0,.35) 0%,rgba(0,0,0,.22) 45%,rgba(0,0,0,.10) 75%,rgba(0,0,0,0) 100%);
  }

  #book{width:100%;height:100%;background:transparent}

  /* полный сброс рамок/теней библиотеки */
  .stf__wrapper,.stf__block,.stf__item,.stf__page,.stf__content{
    background:transparent!important;margin:0!important;padding:0!important;border:0!important;box-shadow:none!important
  }
  .stf__page{overflow:visible!important}

  /* страница = PNG без деформации */
  .page{position:relative;width:100%;height:100%}
  .page img{width:100%;height:100%;object-fit:contain;display:block;user-select:none;-webkit-user-drag:none;pointer-events:none}

  /* тень вокруг САМОЙ картинки страницы (учитывает альфу PNG) */
  .stf__item:not(.stf__item--hard){
    filter:
      drop-shadow(0 14px 18px rgba(0,0,0,.28))
      drop-shadow(0 2px 8px rgba(0,0,0,.22));
  }

  /* внешняя виньетка полей + корешок у разворота */
  .stf__item--left::after,.stf__item--right::after{
    content:"";position:absolute;inset:0;pointer-events:none;mix-blend-mode:multiply;z-index:1
  }
  .stf__item--left::after {background:linear-gradient(90deg, rgba(0,0,0,.20) 0%, rgba(0,0,0,0) 14%)}
  .stf__item--right::after{background:linear-gradient(90deg, rgba(0,0,0,0) 86%, rgba(0,0,0,.20) 100%)}

  .stf__item--left::before,.stf__item--right::before{
    content:"";position:absolute;top:0;bottom:0;width:3.2%;pointer-events:none;mix-blend-mode:multiply;opacity:.42;z-index:1
  }
  .stf__item--left::before {right:0;background:linear-gradient(90deg, rgba(0,0,0,.70), rgba(0,0,0,0))}
  .stf__item--right::before{left:0; background:linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,.70))}

  /* на одиночной странице (обложка/задник) корешковые виньетки скрываем */
  .single .stf__item::before{display:none}
  .single .stf__item--left::after,
  .single .stf__item--right::after{background:none}

  /* невидимые хит-зоны для Genially (перехватываем pointerdown) */
  .hit{position:absolute;top:0;bottom:0;width:50%;z-index:5;background:transparent}
  .hit.left{left:0}
  .hit.right{right:0}

  /* оверлей ошибок */
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);color:#fff;z-index:9999;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
  .overlay.show{display:flex}
  .overlay .panel{background:#121212;border:1px solid #333;border-radius:12px;padding:12px 14px;max-width:720px}
</style>
</head>
<body>
  <div id="scene" class="scene">
    <div id="frame" class="book-frame">
      <div id="book"></div>
      <div class="hit left"></div>
      <div class="hit right"></div>
    </div>
    <div id="ovl" class="overlay"><div id="ovlMsg" class="panel">Ошибка</div></div>
  </div>

  <audio id="flipSound" preload="auto" src="https://raw.githubusercontent.com/NikaShum93/bookflip/main/flip.mp3"></audio>
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
  <script>
  (function(){
    const qs = new URLSearchParams(location.search);
    const urls = (qs.get('imgs')||'').split(/[|,]/).map(s=>s.trim()).filter(Boolean)
      .map(s=>{try{return decodeURIComponent(s)}catch{return s}});
    if(!urls.length) return err('Пустой imgs — нет изображений.');

    const flipTime = +qs.get('flipTime')>0 ? +qs.get('flipTime') : 800;
    let pageW = parseInt(qs.get('w'),10) || 600;
    let pageH = parseInt(qs.get('h'),10) || 900;

    const scene=document.getElementById('scene');
    const frame=document.getElementById('frame');
    const book =document.getElementById('book');

    /* рамка 2*w × h и масштаб под iframe */
    function setSize(){
      frame.style.width  = (pageW*2)+'px';
      frame.style.height =  pageH+'px';
      fit();
    }
    function fit(){
      const s = Math.min(scene.clientWidth/(pageW*2), scene.clientHeight/pageH);
      frame.style.transform = 'scale('+s+')';
    }
    setSize(); addEventListener('resize',fit,{passive:true});

    /* PageFlip */
    const pf = new St.PageFlip(book,{
      width:pageW, height:pageH, size:'fixed', autoSize:false,
      showCover:true, usePortrait:false,
      flippingTime:flipTime, drawShadow:true, maxShadowOpacity:.85,
      mobileScrollSupport:true, clickEventForward:false, useMouseEvents:true, showHint:false
    });

    /* страницы */
    const pages=[];
    urls.forEach((src,i)=>{
      const p=document.createElement('div'); p.className='page';
      p.setAttribute('data-density', (i===0||i===urls.length-1)?'hard':'soft');
      const img=document.createElement('img'); img.src=src; img.alt='';
      p.appendChild(img); book.appendChild(p); pages.push(p);
    });
    (typeof pf.loadFromHTML==='function') ? pf.loadFromHTML(pages) : pf.loadFromImages(urls);

    /* single-режим для обложки/задника */
    function syncSingle(){
      const i = pf.getCurrentPageIndex();
      frame.classList.toggle('single', (i===0||i===urls.length-1));
    }
    syncSingle(); pf.on('flip', syncSingle);

    /* звук + анти-даблклик */
    const snd = document.getElementById('flipSound');
    pf.on('flip', ()=>{ try{ snd.currentTime=0; snd.play(); }catch(e){} });
    let lock=false;
    function safeFlip(dir){
      if(lock || pf.isFlipping()) return;
      lock=true;
      dir==='prev' ? pf.flipPrev('top') : pf.flipNext('top');
      setTimeout(()=>lock=false, pf.getSettings().flippingTime+50);
    }

    /* клики и стрелки (на всякий случай оставим) */
    scene.addEventListener('click', e=>{
      const r=scene.getBoundingClientRect();
      safeFlip((e.clientX-r.left)<r.width/2 ? 'prev' : 'next');
    });
    addEventListener('keydown', e=>{
      if(e.key==='ArrowLeft')  safeFlip('prev');
      if(e.key==='ArrowRight') safeFlip('next');
    });

    /* Хит-зоны: pointerdown + preventDefault — критично для Genially */
    function bindHit(el, dir){
      el.addEventListener('pointerdown', e=>{ safeFlip(dir); e.preventDefault(); }, {passive:false});
      el.addEventListener('touchstart', e=>{ safeFlip(dir); e.preventDefault(); }, {passive:false});
    }
    bindHit(frame.querySelector('.hit.left'),  'prev');
    bindHit(frame.querySelector('.hit.right'), 'next');

    function err(msg){ const o=document.getElementById('ovl'),m=document.getElementById('ovlMsg'); m.textContent=msg; o.classList.add('show'); }
  })();
  </script>
</body>
</html>
