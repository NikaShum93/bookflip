<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BookFlip Viewer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<style>
  html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:transparent}
  #book{position:absolute;inset:0;background:transparent;overflow:hidden;
        filter:drop-shadow(0 14px 22px rgba(0,0,0,.25));}

  /* никаких внутренних полей у библиотеки */
  .stf__wrapper,.stf__block,.stf__item,.stf__page,.stf__content{
    background:transparent !important; margin:0 !important; padding:0 !important; border:0 !important; box-shadow:none !important;
  }
  .stf__page{overflow:hidden}

  /* виньетки: только внешние края; у центра нет */
  .stf__item--left::after, .stf__item--right::after{
    content:""; position:absolute; inset:0; pointer-events:none; mix-blend-mode:multiply;
  }
  .stf__item--left::after{
    background:linear-gradient(90deg, rgba(0,0,0,.16) 0%, rgba(0,0,0,0) 12%, rgba(0,0,0,0) 100%);
  }
  .stf__item--right::after{
    background:linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 88%, rgba(0,0,0,.16) 100%);
  }
  /* обложка/задняя — без виньеток */
  #book.single .stf__item::after{ display:none; }

  .page{width:100%;height:100%}
  .page img{
    width:100%; height:100%;
    object-fit:contain;   /* у тебя страницы уже в точном размере */
    display:block; user-select:none; -webkit-user-drag:none;
  }

  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.25);color:#fff;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;z-index:9999}
  .overlay.show{display:flex}
  .overlay .panel{background:#121212;border:1px solid #333;border-radius:12px;padding:12px 14px;max-width:720px}
</style>
</head>
<body>
<div id="book"></div>
<div id="ovl" class="overlay"><div class="panel" id="ovlMsg">Ошибка</div></div>

<audio id="flipSound" preload="auto"></audio>
<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
<script>
(function(){
  const qs = new URLSearchParams(location.search);

  // изображения (| или ,)
  const urls = (qs.get('imgs')||'')
    .split(/[|,]/).map(s=>s.trim()).filter(Boolean)
    .map(s=>{try{return decodeURIComponent(s)}catch{return s}});

  if (!urls.length) return error('Пустой imgs — нет изображений.');

  // параметры с редактора
  const flipTime = +qs.get('flipTime') > 0 ? +qs.get('flipTime') : 800;
  const showHint = qs.get('showHint') === 'true';
  const sfxUrl   = (qs.get('sfx')||'').trim() || 'https://raw.githubusercontent.com/NikaShum93/bookflip/main/flip.mp3';

  const bookEl = document.getElementById('book');

  // размеры страницы: сначала пробуем w/h; если нет — берём из iframe
  let pageW = parseInt(qs.get('w'),10);
  let pageH = parseInt(qs.get('h'),10);
  if (!(pageW>0 && pageH>0)) {
    const W = Math.max(100, bookEl.clientWidth);
    const H = Math.max(100, bookEl.clientHeight);
    pageW = Math.floor(W/2);
    pageH = H;
  }

  const pf = new St.PageFlip(bookEl, {
    width: pageW,
    height: pageH,
    size: 'fixed',
    autoSize: false,
    showCover: true,       // обложка твёрдая
    usePortrait: false,    // разворот 2 страницы
    flippingTime: flipTime,
    maxShadowOpacity: 0.6, // волна
    drawShadow: true,
    clickEventForward: true,
    mobileScrollSupport: true,
    useMouseEvents: true,
    showHint: showHint
  });

  // страницы: крайние — hard, внутренние — soft
  const host = document.createElement('div');
  urls.forEach((src,i)=>{
    const p = document.createElement('div'); p.className='page';
    p.setAttribute('data-density', (i===0 || i===urls.length-1) ? 'hard' : 'soft');
    const img = document.createElement('img'); img.src = src; img.alt = '';
    p.appendChild(img); host.appendChild(p);
  });
  const nodes = host.querySelectorAll('.page');
  if (typeof pf.loadFromHTML === 'function') pf.loadFromHTML(nodes);
  else pf.loadFromImages(urls);

  // звук
  const flipSound = document.getElementById('flipSound');
  flipSound.src = sfxUrl;
  pf.on('flip', ()=>{ try{ flipSound.currentTime=0; flipSound.play(); }catch(e){} });

  // клики + стрелки
  bookEl.addEventListener('click', (e)=>{
    const x = e.clientX - bookEl.getBoundingClientRect().left;
    (x < bookEl.clientWidth/2) ? pf.flipPrev('top') : pf.flipNext('top');
  });
  window.addEventListener('keydown', (e)=>{
    if (e.key==='ArrowLeft') pf.flipPrev('bottom');
    else if (e.key==='ArrowRight') pf.flipNext('bottom');
  });

  // прятать виньетки, когда видна одна страница
  function syncSingle(){
    const i = pf.getCurrentPageIndex();
    const single = (i===0 || i===urls.length-1);
    bookEl.classList.toggle('single', single);
  }
  syncSingle();
  pf.on('flip', syncSingle);

  function error(msg){ const o=document.getElementById('ovl'); const m=document.getElementById('ovlMsg'); m.textContent=msg; o.classList.add('show'); }
})();
</script>
</body>
</html>
