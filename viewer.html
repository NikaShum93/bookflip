<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PageFlip Viewer (robust loader)</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<noscript><link rel="stylesheet" href="https://unpkg.com/page-flip@2.0.7/dist/css/page-flip.min.css"></noscript>

<style>
  html,body{height:100%;margin:0;background:#000}
  .wrap{position:fixed;inset:0;display:grid;place-items:center}
  .book{position:relative;width:min(96vw, 1200px);height:min(90vh, 800px)}
  #flip{position:absolute;inset:0}

  /* каждая страница = один элемент .page */
  .page{width:100%;height:100%;display:grid;place-items:stretch;background:#111}
  .page .full{
    width:100%;height:100%;
    background-repeat:no-repeat;background-position:center center;background-size:cover;
    border:2px solid #555;box-sizing:border-box;backface-visibility:hidden;
    transform:translateZ(0.1px);border-radius:2px;
  }

  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.6);color:#fff;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;z-index:9999}
  .overlay .panel{background:#121212;border:1px solid #333;border-radius:12px;padding:16px 18px;max-width:720px}
  .overlay .panel b{color:#ffd27d}
  .overlay .list{max-height:220px;overflow:auto;margin-top:8px;font-family:ui-monospace,Consolas,monospace;font-size:12px}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="book"><div id="flip"></div></div>
</div>

<div id="ovl" class="overlay"><div class="panel">
  <div id="ovlTitle">Загрузка…</div>
  <div id="ovlBody" class="list"></div>
</div></div>

<script>
(function(){
  const ovl = document.getElementById('ovl');
  const t = document.getElementById('ovlTitle');
  const b = document.getElementById('ovlBody');
  const show = (msg, list)=>{ t.textContent=msg; b.innerHTML=(list||[]).map(x=>`<div>${x}</div>`).join(''); ovl.classList.remove('hidden'); };
  const hide = ()=>ovl.classList.add('hidden');

  // параметры
  const q = new URLSearchParams(location.search);
  const rawImgs = (q.get('imgs')||'').split(/[|,]/).map(s=>s.trim()).filter(Boolean).map(s=>{try{return decodeURIComponent(s)}catch{return s}});
  const flipTime = Number(String(q.get('flipTime')||'').replace(',', '.')) || 800;
  const tilt     = Number(String(q.get('tilt')||'').replace(',', '.')) || 2;
  const sfxUrl   = (q.get('sfx')||'').trim();
  const showHint = (q.get('showHint')||'false') === 'true';

  const fallbacks = [
    "https://images.unsplash.com/photo-1514511542842-209a87b229c6?q=80&w=1200&auto=format&fit=crop",
    "https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?q=80&w=1200&auto=format&fit=crop",
    "https://images.unsplash.com/photo-1529336953121-adb2f3f1c6b6?q=80&w=1200&auto=format&fit=crop"
  ];
  const pages = rawImgs.length ? rawImgs : fallbacks;

  // предзагрузка картинок
  show('Загружаю изображения…');
  const preload = src => new Promise(res=>{ const im=new Image(); im.onload=()=>res({ok:true,src}); im.onerror=()=>res({ok:false,src}); im.src=src; });
  Promise.all(pages.map(preload)).then(rs=>{
    const bad = rs.filter(r=>!r.ok).map(r=>r.src);
    const ok  = rs.filter(r=>r.ok).map(r=>r.src);
    if (!ok.length){ show('Нет ни одного доступного изображения. Проверь ссылки.'); return; }
    if (bad.length){ show('Часть изображений не загрузилась. Остальные откроются.', bad); }
    return loadScript('https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js')
      .catch(()=>loadScript('https://unpkg.com/page-flip@2.0.7/dist/js/page-flip.browser.min.js'))
      .then(()=>ok);
  }).then(okUrls=>{
    if (!okUrls) return;
    if (!(window.St && window.St.PageFlip)){ show('Ошибка инициализации книги: St is not defined'); return; }
    init(okUrls);
  }).catch(e=>show('Ошибка: '+(e&&e.message?e.message:e)));

  function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=()=>res(); s.onerror=()=>rej(new Error('Не удалось загрузить '+src)); document.head.appendChild(s); }); }

  function init(imgUrls){
    try{
      // создаём HTML-страницы (класс .page)
      const pageEls = imgUrls.map(src=>{
        const p = document.createElement('div'); p.className='page';
        const inner = document.createElement('div'); inner.className='full';
        inner.style.backgroundImage = `url("${src}")`;
        inner.style.transform = `rotateX(${tilt}deg) translateZ(0.1px)`;
        p.appendChild(inner);
        return p;
      });

      const flipRoot = document.getElementById('flip');
      const rect = flipRoot.getBoundingClientRect();
      let pageWidth  = Math.max(220, Math.floor((rect.width||800)/2));
      let pageHeight = Math.max(220, Math.floor(rect.height||600));

      const pf = new St.PageFlip(flipRoot, {
        width: pageWidth,
        height: pageHeight,
        size: 'stretch',
        minWidth: 180, minHeight: 180,
        maxShadowOpacity: 0.25,
        flippingTime: flipTime,
        showHint: showHint,
        usePortrait: false,
        autoSize: true,
        clickEventForward: true,
        mobileScrollSupport: true,
        drawShadow: true
      });

      // правильный метод — loadFromHTML (с заглавными)
      if (typeof pf.loadFromHTML === 'function') {
        pf.loadFromHTML(pageEls);
      } else if (typeof pf.loadFromImages === 'function') {
        pf.loadFromImages(imgUrls);
      } else {
        throw new Error('Нет подходящего метода загрузки страниц');
      }

      // звук
      let sfx=null; if (sfxUrl){ try{ sfx=new Audio(sfxUrl); sfx.preload='auto'; }catch(e){} }
      pf.on('flip', ()=>{ if(sfx){ sfx.currentTime=0; sfx.play().catch(()=>{}); } });

      // ← → для навигации
      window.addEventListener('keydown', e=>{
        if (e.key==='ArrowRight') pf.flipNext('bottom');
        else if (e.key==='ArrowLeft') pf.flipPrev('bottom');
      });

      // ресайз
      window.addEventListener('resize', ()=>{
        const r = flipRoot.getBoundingClientRect();
        pf.update({ width: Math.max(220, Math.floor((r.width||800)/2)),
                    height: Math.max(220, Math.floor(r.height||600)) });
      });

      hide();
    }catch(e){
      show('Ошибка инициализации книги: ' + (e && e.message ? e.message : e));
    }
  }
})();
</script>
</body>
</html>
