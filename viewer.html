<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teachy Witchy — Book Viewer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<style>
  /* Прозрачный фон всего iframe */
  html,body{margin:0;height:100%;background:transparent;overflow:hidden}

  /* Сцена: центрируем, ничего не режем */
  .scene{
    position:relative;width:100%;height:100%;
    display:flex;align-items:center;justify-content:center;
    background:transparent;overflow:visible;
  }

  /* Рамка «натурального» размера книги (2*w × h), масштабируем целиком */
  .book-frame{position:relative;transform-origin:center center;will-change:transform;overflow:visible}

  /* Тень под книгой (разворот) */
  .book-frame::after{
    content:"";position:absolute;left:6%;right:6%;bottom:-18px;height:36px;pointer-events:none;
    filter:blur(10px);
    background:radial-gradient(60% 100% at 50% 0%, rgba(0,0,0,.35) 0%, rgba(0,0,0,.22) 45%, rgba(0,0,0,.10) 75%, rgba(0,0,0,0) 100%);
  }
  /* В режиме «только обложка» — тень только под правой половиной */
  .single .book-frame::after{left:var(--cover-left,50%);right:6%}

  /* Виджет */
  #book{width:100%;height:100%;background:transparent}
  /* Главное: не клипать анимацию */
  .stf__wrapper,.stf__block{overflow:visible !important}
  /* Страницы без белого фона */
  .stf__page{background:transparent !important;overflow:hidden}

  /* Картинка на странице: без деформации; если не влезла по пропорциям — прозрачные поля */
  .page{position:relative;width:100%;height:100%;background:transparent}
  .page img{width:100%;height:100%;object-fit:contain;display:block;user-select:none;-webkit-user-drag:none;pointer-events:none}

  /* Бумажный объём */
  .stf__page{
    box-shadow:inset 0 0 0 1px rgba(0,0,0,.04), 0 6px 12px rgba(0,0,0,.08);
  }
  .stf__page::before,.stf__page::after{
    content:"";position:absolute;top:0;bottom:0;width:var(--edge,12px);pointer-events:none;opacity:.45
  }
  .stf__page::before{left:0;background:linear-gradient(90deg,rgba(0,0,0,.12),rgba(0,0,0,0))}
  .stf__page::after{right:0;background:linear-gradient(270deg,rgba(0,0,0,.12),rgba(0,0,0,0))}

  .stf__item--left::after,.stf__item--right::after{content:"";position:absolute;inset:0;pointer-events:none;mix-blend-mode:multiply}
  .stf__item--left::after{ background:linear-gradient(90deg,rgba(0,0,0,.16) 0%,rgba(0,0,0,0) 12%) }
  .stf__item--right::after{background:linear-gradient(90deg,rgba(0,0,0,0) 88%,rgba(0,0,0,.16) 100%)}

  .stf__item--left::before,.stf__item--right::before{
    content:"";position:absolute;top:0;bottom:0;width:3.2%;pointer-events:none;mix-blend-mode:multiply;opacity:.30
  }
  .stf__item--left::before{ right:0;background:linear-gradient(90deg,rgba(0,0,0,.55),rgba(0,0,0,0)) }
  .stf__item--right::before{left:0;background:linear-gradient(90deg,rgba(0,0,0,0),rgba(0,0,0,.55))}

  /* В режиме обложки/задника убираем корешковые виньетки */
  .single .stf__item::before{display:none}
  .single .stf__item--left::after,.single .stf__item--right::after{background:none}

  /* Оверлей ошибок */
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);color:#fff;z-index:9}
  .overlay.show{display:flex}
  .overlay .panel{background:#121212;border:1px solid #333;border-radius:12px;padding:12px 14px}
</style>
</head>
<body>
  <div id="scene" class="scene">
    <div id="frame" class="book-frame">
      <div id="book"></div>
    </div>
    <div id="ovl" class="overlay"><div id="ovlMsg" class="panel">Ошибка</div></div>
  </div>

  <audio id="flipSound" preload="auto" src="https://raw.githubusercontent.com/NikaShum93/bookflip/main/flip.mp3"></audio>
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
  <script>
  (function(){
    const qs=new URLSearchParams(location.search);
    const urls=(qs.get('imgs')||'').split(/[|,]/).map(s=>{s=s.trim();try{return decodeURIComponent(s)}catch{return s}}).filter(Boolean);
    if(!urls.length){ return err('Пустой imgs — нет изображений.'); }

    const flipTime = +qs.get('flipTime')>0 ? +qs.get('flipTime') : 800;
    let pageW = parseInt(qs.get('w'),10)||600;
    let pageH = parseInt(qs.get('h'),10)||900;

    const scene=document.getElementById('scene');
    const frame=document.getElementById('frame');
    const book =document.getElementById('book');

    function setFrameSize(){
      frame.style.width  =(pageW*2)+'px';
      frame.style.height = pageH+'px';
      frame.style.setProperty('--cover-left', pageW+'px');

      const edge=Math.round(Math.max(8,Math.min(18,pageW*0.02)));
      frame.style.setProperty('--edge', edge+'px');

      fit();
    }
    function fit(){
      const availW=scene.clientWidth, availH=scene.clientHeight;
      const needW=pageW*2,           needH=pageH;
      const scale=Math.min(availW/needW, availH/needH);
      frame.style.transform='scale('+scale+')';
    }
    window.addEventListener('resize',fit);
    setFrameSize();

    const pf=new St.PageFlip(book,{
      width:pageW,
      height:pageH,
      size:'fixed',
      autoSize:false,
      usePortrait:false,   // ← всегда разворот (кроме обложки/задней)
      showCover:true,
      flippingTime:flipTime,
      drawShadow:true,
      maxShadowOpacity:.85,
      mobileScrollSupport:true,
      showHint:false
    });

    // Генерим страницы
    const host=document.createElement('div');
    urls.forEach((src,i)=>{
      const p=document.createElement('div'); p.className='page';
      p.setAttribute('data-density', (i===0||i===urls.length-1)?'hard':'soft');
      const img=document.createElement('img'); img.src=src; img.alt='';
      p.appendChild(img); host.appendChild(p);
    });
    const nodes=host.querySelectorAll('.page');
    if(typeof pf.loadFromHTML==='function') pf.loadFromHTML(nodes); else pf.loadFromImages(urls);

    // Звук и переключение режима single
    const flipSound=document.getElementById('flipSound');
    function syncSingle(){
      const i=pf.getCurrentPageIndex();
      frame.classList.toggle('single', (i===0||i===urls.length-1));
    }
    pf.on('flip', ()=>{
      try{ flipSound.currentTime=0; flipSound.play(); }catch(e){}
      syncSingle();
    });
    syncSingle();

    // Клики/стрелки
    let lock=false;
    function safeFlip(dir){ if(lock||pf.isFlipping())return; lock=true; dir==='prev'?pf.flipPrev('top'):pf.flipNext('top'); setTimeout(()=>lock=false, pf.getSettings().flippingTime+40); }
    scene.addEventListener('click',e=>{const r=scene.getBoundingClientRect();safeFlip((e.clientX-r.left)<r.width/2?'prev':'next');});
    window.addEventListener('keydown',e=>{if(e.key==='ArrowLeft')safeFlip('prev'); if(e.key==='ArrowRight')safeFlip('next');});

    function err(msg){const o=document.getElementById('ovl'),m=document.getElementById('ovlMsg');m.textContent=msg;o.classList.add('show');}
  })();
  </script>
</body>
</html>
