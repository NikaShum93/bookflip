<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BookFlip Viewer</title>

<!-- CSS библиотеки -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<noscript><link rel="stylesheet" href="https://unpkg.com/page-flip@2.0.7/dist/css/page-flip.min.css"></noscript>

<style>
  :root{
    /* регулировка интенсивности теней (0–1.0) */
    --depth: .35;
    --edge:  .22;
  }
  html,body{height:100%;margin:0;background:transparent}
  .wrap{position:fixed;inset:0;display:grid;place-items:center;background:transparent}
  .book{position:relative;width:min(96vw,1200px);height:min(90vh,800px);background:transparent}
  #flip{position:absolute;inset:0;background:transparent}

  /* ===== объёмные тени ===== */
  /* внешняя мягкая тень под книгой */
  .book::after{
    content:""; position:absolute; left:6%; right:6%; bottom:-12px; height:28px;
    filter: blur(10px);
    background:
      radial-gradient(60% 100% at 50% 0%,
        rgba(0,0,0,calc(.9*var(--depth))) 0%,
        rgba(0,0,0,0) 70%);
    pointer-events:none;
  }
  /* корешок (внутренняя тень по центру) */
  #flip::before{
    content:""; position:absolute; top:2.5%; bottom:2.5%; left:50%; width:56px; transform:translateX(-50%);
    pointer-events:none;
    background:
      linear-gradient(90deg,
        rgba(0,0,0,0) 0%,
        rgba(0,0,0,calc(.85*var(--depth))) 50%,
        rgba(0,0,0,0) 100%);
    filter: blur(10px);
    opacity:.9;
  }
  /* лёгкая виньетка по внешним краям страниц */
  .stf__item::after{
    content:""; position:absolute; inset:0; pointer-events:none; mix-blend-mode:multiply;
    background:
      linear-gradient(90deg,
        rgba(0,0,0,calc(var(--edge))) 0%,
        rgba(0,0,0,0) 18%,
        rgba(0,0,0,0) 82%,
        rgba(0,0,0,calc(var(--edge))) 100%);
  }
  /* при сгибе добавим чуть больше контраста у активной */
  .stf__item--active::after{
    background:
      linear-gradient(90deg,
        rgba(0,0,0,calc(1.4*var(--edge))) 0%,
        rgba(0,0,0,0) 18%,
        rgba(0,0,0,0) 82%,
        rgba(0,0,0,calc(1.4*var(--edge))) 100%);
  }
  /* ================================= */
</style>

</head>
<body>
<div class="wrap">
  <div class="book"><div id="flip"></div></div>
</div>

<div id="ovl" class="overlay"><div class="panel">
  <div id="ovlTitle">Загрузка…</div>
  <div id="ovlBody" class="list"></div>
</div></div>

<script>
(function(){
  const ovl = document.getElementById('ovl');
  const t = document.getElementById('ovlTitle');
  const b = document.getElementById('ovlBody');
  const show = (msg, list)=>{ t.textContent=msg; b.innerHTML=(list||[]).map(x=>`<div>${x}</div>`).join(''); ovl.classList.remove('hidden'); };
  const hide = ()=>ovl.classList.add('hidden');

  // --- читаем параметры ---
  const q = new URLSearchParams(location.search);
  const rawImgs = (q.get('imgs')||'').split(/[|,]/).map(s=>s.trim()).filter(Boolean).map(s=>{try{return decodeURIComponent(s)}catch{return s}});
  const flipTime = Number(String(q.get('flipTime')||'').replace(',', '.')) || 800;
  const tilt     = Number(String(q.get('tilt')||'').replace(',', '.')) || 2;
  const showHint = (q.get('showHint')||'false') === 'true';

  // звук захардкожен
  const sfxUrl = "https://raw.githubusercontent.com/NikaShum93/bookflip/main/flip.mp3";

  // запасные картинки (на случай если не передали imgs)
  const fallbacks = [
    "https://images.unsplash.com/photo-1514511542842-209a87b229c6?q=80&w=1200&auto=format&fit=crop",
    "https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?q=80&w=1200&auto=format&fit=crop",
    "https://images.unsplash.com/photo-1529336953121-adb2f3f1c6b6?q=80&w=1200&auto=format&fit=crop"
  ];
  const imgUrls = rawImgs.length ? rawImgs : fallbacks;

  // --- предзагрузка изображений ---
  show('Загружаю изображения…');
  const preload = src => new Promise(res=>{ const im=new Image(); im.onload=()=>res({ok:true,src}); im.onerror=()=>res({ok:false,src}); im.src=src; });
  Promise.all(imgUrls.map(preload)).then(rs=>{
    const bad = rs.filter(r=>!r.ok).map(r=>r.src);
    const ok  = rs.filter(r=>r.ok).map(r=>r.src);
    if (!ok.length){ show('Нет ни одного доступного изображения. Проверь ссылки.'); return; }
    if (bad.length){ show('Часть изображений не загрузилась. Остальные откроются.', bad); }
    return loadScript('https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js')
      .catch(()=>loadScript('https://unpkg.com/page-flip@2.0.7/dist/js/page-flip.browser.min.js'))
      .then(()=>ok);
  }).then(okUrls=>{
    if (!okUrls) return;
    if (!(window.St && window.St.PageFlip)){ show('Ошибка инициализации книги: St is not defined'); return; }
    init(okUrls);
  }).catch(e=>show('Ошибка: '+(e&&e.message?e.message:e)));

  function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=()=>res(); s.onerror=()=>rej(new Error('Не удалось загрузить '+src)); document.head.appendChild(s); }); }

  function init(pages){
    try{
      const flipRoot = document.getElementById('flip');
      const rect = flipRoot.getBoundingClientRect();
      let pageWidth  = Math.max(220, Math.floor((rect.width||800) / 2));
      let pageHeight = Math.max(220, Math.floor(rect.height||600));

      const pf = new St.PageFlip(flipRoot, {
        width: pageWidth,
        height: pageHeight,
        size: 'stretch',
        minWidth: 180, minHeight: 180,
        maxShadowOpacity: 0.25,
        flippingTime: flipTime,
        showHint: showHint,
        usePortrait: false,
        showCover: true,   // отдельная обложка
        startPage: 0,
        autoSize: true,
        clickEventForward: true,
        mobileScrollSupport: true,
        drawShadow: true
      });

      pf.loadFromImages(pages);

      // наклон (почти прямо)
      const root = flipRoot.closest('.book');
      if (root) root.style.transform = `rotateX(${tilt}deg)`;

      // звук
      let sfx=null; try{ sfx=new Audio(sfxUrl); sfx.preload='auto'; }catch(e){}
      pf.on('flip', ()=>{ if(sfx){ sfx.currentTime=0; sfx.play().catch(()=>{}); } });

      // навигация ← →
      window.addEventListener('keydown', e=>{
        if (e.key==='ArrowRight') pf.flipNext('bottom');
        else if (e.key==='ArrowLeft') pf.flipPrev('bottom');
      });

      // ресайз
      window.addEventListener('resize', ()=>{
        const r = flipRoot.getBoundingClientRect();
        pf.update({ width: Math.max(220, Math.floor((r.width||800)/2)),
                    height: Math.max(220, Math.floor(r.height||600)) });
      });

      hide();
    }catch(e){
      show('Ошибка инициализации книги: ' + (e && e.message ? e.message : e));
    }
  }
})();
</script>
</body>
</html>
