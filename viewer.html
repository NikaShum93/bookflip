<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BookFlip Viewer</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">

<style>
  /* фон прозрачный, без скролла */
  html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:transparent}

  /* книга занимает весь iframe (который = 2*w × h) */
  #book{position:absolute;inset:0;background:transparent;overflow:hidden;
        filter:drop-shadow(0 14px 22px rgba(0,0,0,.25));}

  /* сброс внутренних фонов/отступов библиотеки */
  .stf__wrapper,.stf__block,.stf__item,.stf__page,.stf__content{
    background:transparent !important; margin:0 !important; padding:0 !important; border:0 !important; box-shadow:none !important;
  }
  .stf__page{overflow:hidden}

  /* виньетка по краям каждой страницы (оверлей, не добавляет полей) */
  .stf__item::after{
    content:""; position:absolute; inset:0; pointer-events:none; mix-blend-mode:multiply;
    background:linear-gradient(90deg,
      rgba(0,0,0,.16) 0%,
      rgba(0,0,0,0) 12%,
      rgba(0,0,0,0) 88%,
      rgba(0,0,0,.16) 100%);
  }

  /* страница = одно изображение, ровно по странице */
  .page{width:100%;height:100%}
  .page img{
    width:100%; height:100%;
    object-fit:contain;          /* изображения уже нужного размера => без полей */
    display:block; user-select:none; -webkit-user-drag:none;
  }

  /* оверлей только для ошибок */
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.25);color:#fff;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;z-index:9999}
  .overlay.show{display:flex}
  .overlay .panel{background:#121212;border:1px solid #333;border-radius:12px;padding:16px 18px;max-width:720px}
</style>
</head>
<body>

<div id="book"></div>

<div id="ovl" class="overlay"><div class="panel" id="ovlMsg">Ошибка</div></div>

<audio id="flipSound" src="https://raw.githubusercontent.com/NikaShum93/bookflip/main/flip.mp3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
<script>
(function(){
  const qs = new URLSearchParams(location.search);

  // список изображений (разделители | или ,)
  const urls = (qs.get('imgs')||'')
    .split(/[|,]/).map(s=>s.trim()).filter(Boolean)
    .map(s=>{try{return decodeURIComponent(s)}catch{return s}});

  // размер ОДНОЙ страницы из редактора
  const W = parseInt(qs.get('w'),10);
  const H = parseInt(qs.get('h'),10);

  if (!urls.length) return showErr('Параметр imgs пуст — нет изображений.');
  if (!(W>0 && H>0)) return showErr('Не передан размер страницы: w×h.');

  const bookEl = document.getElementById('book');

  // инициализация движка: размер страницы ровно w×h
  const pf = new St.PageFlip(bookEl, {
    width: W,                 // ширина ОДНОЙ страницы
    height: H,                // высота страницы
    size: 'fixed',            // фикс — без автоподгонки
    autoSize: false,
    showCover: true,          // обложка — отдельная страница (твёрдая)
    usePortrait: false,       // разворот из двух страниц
    flippingTime: 800,        // скорость
    maxShadowOpacity: 0.6,    // тени для «волны»
    drawShadow: true,
    clickEventForward: true,
    mobileScrollSupport: true,
    useMouseEvents: true
  });

  // создаём DOM страниц: первая/последняя — hard, остальные — soft
  const host = document.createElement('div');
  urls.forEach((src, i)=>{
    const p = document.createElement('div'); p.className='page';
    p.setAttribute('data-density', (i===0 || i===urls.length-1) ? 'hard' : 'soft');
    const img = document.createElement('img'); img.src = src; img.alt = '';
    p.appendChild(img); host.appendChild(p);
  });

  const pagesNodes = host.querySelectorAll('.page');
  if (typeof pf.loadFromHTML === 'function') pf.loadFromHTML(pagesNodes);
  else if (typeof pf.loadFromImages === 'function') pf.loadFromImages(urls);

  // звук
  const flipSound = document.getElementById('flipSound');
  pf.on('flip', ()=>{ try{ flipSound.currentTime=0; flipSound.play(); }catch(e){} });

  // навигация: клики по сторонам + клавиши
  bookEl.addEventListener('click', (e)=>{
    const x = e.clientX - bookEl.getBoundingClientRect().left;
    if (x < bookEl.clientWidth/2) pf.flipPrev('top'); else pf.flipNext('top');
  });
  window.addEventListener('keydown', (e)=>{
    if (e.key==='ArrowLeft') pf.flipPrev('bottom');
    else if (e.key==='ArrowRight') pf.flipNext('bottom');
  });

  // никакого ресайза — размер фиксирован под w×h (как задал редактор)

  function showErr(msg){ const o=document.getElementById('ovl'); const m=document.getElementById('ovlMsg'); m.textContent=msg; o.classList.add('show'); }
})();
</script>
</body>
</html>
