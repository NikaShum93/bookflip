<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teachy Witchy — Book Viewer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<style>
  /* прозрачный фон, ничего лишнего */
  html,body{margin:0;height:100%;background:transparent;overflow:hidden}
  .scene{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:transparent}

  /* рамка натурального размера (2w×h), на неё вешаем scale */
  .book-frame{
    position:relative; transform-origin:center center; will-change:transform;
    --shadow-left:6%;   /* границы тени по умолчанию — под обоими листами */
    --shadow-right:6%;
  }
  /* «тень под книгой на столе» — мягкая и только ПОД видимой частью */
  .book-frame::after{
    content:""; position:absolute; pointer-events:none; z-index:-1;
    left:var(--shadow-left); right:var(--shadow-right);
    bottom:-18px; height:36px; filter:blur(10px);
    background:radial-gradient(60% 100% at 50% 0%,
      rgba(0,0,0,.35) 0%,
      rgba(0,0,0,.22) 45%,
      rgba(0,0,0,.10) 75%,
      rgba(0,0,0,0) 100%);
  }

  /* сам виджет */
  #book{width:100%;height:100%;background:transparent}

  /* обнуляем внутренние поля/тени библиотеки */
  .stf__wrapper,.stf__block,.stf__item,.stf__page,.stf__content{
    background:transparent!important;margin:0!important;padding:0!important;border:0!important;box-shadow:none!important;
  }
  .stf__page{overflow:hidden; position:relative}

  /* контент страницы — картинка без искажений */
  .page{width:100%;height:100%;position:relative}
  .page img{
    width:100%;height:100%;object-fit:contain;display:block;
    user-select:none;-webkit-user-drag:none;pointer-events:none;
  }

  /* --- ОБЪЁМ СТРАНИЦ (виньетка + затемнение кромок), клики не перекрываем --- */
  .stf__page::after{ /* лёгкая виньетка по площади страницы */
    content:""; position:absolute; inset:0; pointer-events:none; z-index:2; mix-blend-mode:multiply;
    background:radial-gradient(120% 100% at 50% 50%, rgba(0,0,0,.12) 0%, rgba(0,0,0,0) 62%);
  }
  .stf__page::before{ /* затемнение у внешней кромки листа */
    content:""; position:absolute; top:0; bottom:0; width:14px; pointer-events:none; z-index:2; opacity:.45; mix-blend-mode:multiply;
  }
  .stf__item--left  .stf__page::before{ right:0; background:linear-gradient(90deg, rgba(0,0,0,.30), rgba(0,0,0,0)) }
  .stf__item--right .stf__page::before{ left:0;  background:linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,.30)) }

  /* внутренняя тень у корешка только на разворотах */
  .stf__item--left::after,.stf__item--right::after{
    content:""; position:absolute; top:0; bottom:0; width:3.2%; pointer-events:none; z-index:1; mix-blend-mode:multiply; opacity:.35;
  }
  .stf__item--left::after  { right:0; background:linear-gradient(90deg, rgba(0,0,0,.65), rgba(0,0,0,0)) }
  .stf__item--right::after { left:0;  background:linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,.65)) }

  /* на одиночной (обложка/задник) корешковую тень скрываем */
  .single .stf__item::after{ display:none; }

  /* оверлей ошибок */
  .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.25);color:#fff;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;z-index:9999}
  .overlay.show{display:flex}
  .overlay .panel{background:#121212;border:1px solid #333;border-radius:12px;padding:12px 14px;max-width:720px}
</style>
</head>
<body>
  <div id="scene" class="scene">
    <div id="frame" class="book-frame">
      <div id="book"></div>
    </div>
    <div id="ovl" class="overlay"><div class="panel" id="ovlMsg">Ошибка</div></div>
  </div>

  <audio id="flipSound" preload="auto" src="https://raw.githubusercontent.com/NikaShum93/bookflip/main/flip.mp3"></audio>
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
  <script>
  (function(){
    const qs = new URLSearchParams(location.search);

    /* надёжный декодер для Genially: разворачивает %253A → : и т.п. */
    function safeDecodeN(s, times=3){
      let prev=s, cur=s;
      for(let i=0;i<times;i++){
        try{ cur = decodeURIComponent(prev); }catch(_){ break; }
        if(cur===prev) break;
        prev = cur;
      }
      return cur;
    }

    /* imgs может прийти двойным/тройным URL-энкодом; разделитель — | */
    let rawImgs = qs.get('imgs') || '';
    rawImgs = safeDecodeN(rawImgs, 3);
    const urls = rawImgs.split('|').map(s=>s.trim()).filter(Boolean);
    if (!urls.length) return err('Пустой imgs — нет изображений.');

    const flipTime = +qs.get('flipTime') > 0 ? +qs.get('flipTime') : 800;
    let pageW = parseInt(qs.get('w'),10) || 600;
    let pageH = parseInt(qs.get('h'),10) || 900;

    const scene  = document.getElementById('scene');
    const frame  = document.getElementById('frame');
    const bookEl = document.getElementById('book');

    function setFrameSize(){
      frame.style.width  = (pageW * 2) + 'px';
      frame.style.height =  pageH + 'px';
      fitToScene();
    }
    function fitToScene(){
      const availW = scene.clientWidth, availH = scene.clientHeight;
      const needW = pageW * 2, needH = pageH;
      const s = Math.min(availW/needW, availH/needH);
      frame.style.transform = 'scale('+s+')';
    }
    setFrameSize();
    addEventListener('resize', fitToScene, {passive:true});

    /* PageFlip — базовые настройки, как в «рабочей» версии */
    const pf = new St.PageFlip(bookEl, {
      width: pageW, height: pageH, size:'fixed', autoSize:false,
      showCover:true, usePortrait:false,
      flippingTime: flipTime, maxShadowOpacity:.85, drawShadow:true,
      mobileScrollSupport:true, useMouseEvents:true, clickEventForward:false,
      showHint:false
    });

    /* заполняем страницами */
    const host=document.createElement('div');
    urls.forEach((src,i)=>{
      const p=document.createElement('div'); p.className='page';
      p.setAttribute('data-density', (i===0||i===urls.length-1)?'hard':'soft');
      const img=document.createElement('img'); img.src=src; img.alt='';
      p.appendChild(img); host.appendChild(p);
    });
    const nodes = host.querySelectorAll('.page');
    if (typeof pf.loadFromHTML==='function') pf.loadFromHTML(nodes); else pf.loadFromImages(urls);

    /* звук + переключение режима single/двухстраничного + сужение тени под книгой */
    const flipSound = document.getElementById('flipSound');
    function syncState(){
      const i = pf.getCurrentPageIndex();
      const last = urls.length-1;
      const isSingle = (i===0 || i===last);
      frame.classList.toggle('single', isSingle);

      /* подстраиваем ширину тени ПОД видимой частью:
         - обложка (справа)  → тень только под правой половиной
         - задник  (слева)   → тень только под левой половиной
         - разворот          → тень под всей книгой
      */
      if(!isSingle){ frame.style.setProperty('--shadow-left','6%'); frame.style.setProperty('--shadow-right','6%'); }
      else if(i===0){          /* обложка (справа) */
        frame.style.setProperty('--shadow-left','52%');  /* ~50% + немного поля */
        frame.style.setProperty('--shadow-right','6%');
      }else{                   /* задняя обложка (слева) */
        frame.style.setProperty('--shadow-left','6%');
        frame.style.setProperty('--shadow-right','52%');
      }
    }
    syncState();
    pf.on('flip', ()=>{ syncState(); try{ flipSound.currentTime=0; flipSound.play(); }catch(_){}});

    /* клики/стрелки — как в рабочем коде */
    let lock=false;
    function safeFlip(dir){
      if(lock||pf.isFlipping()) return;
      lock=true;
      dir==='prev' ? pf.flipPrev('top') : pf.flipNext('top');
      setTimeout(()=>lock=false, pf.getSettings().flippingTime+40);
    }
    scene.addEventListener('click', (e)=>{
      const r = scene.getBoundingClientRect();
      safeFlip((e.clientX-r.left) < r.width/2 ? 'prev' : 'next');
    });
    addEventListener('keydown', (e)=>{
      if(e.key==='ArrowLeft')  safeFlip('prev');
      if(e.key==='ArrowRight') safeFlip('next');
    });

    function err(msg){ const o=document.getElementById('ovl'), m=document.getElementById('ovlMsg'); m.textContent=msg; o.classList.add('show'); }
  })();
  </script>
</body>
</html>
