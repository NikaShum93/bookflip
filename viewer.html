<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>BookFlip Viewer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
<style>
  :root{
    --page-w:600px;          /* будет задано из параметров */
    --page-h:900px;
    --safe-x:0px;            /* прозрачный отступ слева/справа */
    --safe-y:0px;            /* прозрачный отступ сверху/снизу */
    --shadow-op:0.22;        /* тень под книгой */
    --vignette:0.24;         /* виньетка по краям страниц */
  }

  html,body{height:100%;margin:0;background:transparent;overflow:hidden}
  .stage{
    position:relative;
    width: calc( (var(--page-w) * 2) + (var(--safe-x) * 2) );
    height: calc( var(--page-h) + (var(--safe-y) * 2) );
    margin: 0 auto;
    pointer-events:auto;
  }

  /* центрируем «книгу» в стадии */
  .book-wrap{
    position:absolute;
    left: var(--safe-x);
    top:  var(--safe-y);
    width: calc(var(--page-w) * 2);
    height: var(--page-h);
    display:block;
  }

  /* Подложка-тень под всей книгой */
  .book-shadow{
    position:absolute;
    left: 5%;
    width: 90%;
    bottom: max(6px, calc(var(--safe-y) * 0.2));
    height: clamp(10px, calc(var(--page-h) * .05), 60px);
    filter: blur(18px);
    opacity: var(--shadow-op);
    background: radial-gradient(ellipse at center,
      rgba(0,0,0,0.5) 0%,
      rgba(0,0,0,0.35) 40%,
      rgba(0,0,0,0.15) 70%,
      rgba(0,0,0,0.0) 100%);
    pointer-events:none;
  }

  /* Контейнер StPageFlip */
  #book{
    width: 100%;
    height: 100%;
    border-radius: 0; /* никаких скруглений */
    background: transparent;
  }

  /* Виньетка на страницах */
  .stf__item, .stf__item .stf__item_page{
    background: transparent;
  }
  .stf__item .stf__item_page::after{
    content:"";
    position:absolute; inset:0;
    pointer-events:none;
    /* лёгкая внутренняя тень по краям */
    box-shadow:
      inset 40px 0 60px rgba(0,0,0,var(--vignette)),
      inset -40px 0 60px rgba(0,0,0,var(--vignette)),
      inset 0 40px 60px rgba(0,0,0,calc(var(--vignette)*0.65)),
      inset 0 -40px 60px rgba(0,0,0,calc(var(--vignette)*0.65));
  }

  /* Тень корешка — только между страницами (не «выходит» за книгу) */
  .spine{
    position:absolute; top:0; left:50%;
    transform:translateX(-50%);
    width: clamp(10px, 1.4%, 18px);
    height: 100%;
    pointer-events:none;
    background:
      radial-gradient(closest-side, rgba(0,0,0,.22), rgba(0,0,0,.05) 70%, rgba(0,0,0,0) 100%);
    filter: blur(1px);
    opacity:.8;
  }

  /* Лёгкое «приоткрывание» обложки при наведении всей сцены */
  .stage:hover .cover-hint{
    transform: rotateY(-3deg) translateZ(1px);
  }
  .cover-hint{
    position:absolute; left:var(--safe-x); top:var(--safe-y);
    width: calc(var(--page-w) * 2); height: var(--page-h);
    transform-origin: left center;
    transition: transform .25s ease;
    pointer-events:none;
  }
</style>
</head>
<body>
<div id="stage" class="stage" aria-label="book area">
  <div class="book-shadow"></div>
  <div class="spine"></div>
  <div class="book-wrap">
    <div id="book"></div>
  </div>
  <div class="cover-hint"></div>
</div>

<script>
(function(){
  // ---- helpers
  const qs = new URLSearchParams(location.search);
  const must = (k, def=null) => qs.get(k) ?? def;

  // imgs
  const rawImgs = must('imgs','');
  if(!rawImgs){
    alert('Пустой imgs — нет изображений.');
    return;
  }
  const ts = Date.now(); // пробиваем кэш
  const imgs = rawImgs.split('|').map(s => {
    try { s = decodeURIComponent(s); } catch(e){}
    const glue = s.includes('?') ? '&' : '?';
    return s + glue + 'cb=' + ts;
  });

  // размеры страницы
  const W = Math.max(50, parseInt(must('w', 600),10));
  const H = Math.max(50, parseInt(must('h', 900),10));

  // safe-проценты вокруг книги (чтобы анимация не резалась)
  const safePct  = Math.max(0, Math.min(0.35, parseFloat(must('safe', 0.14))));
  const safeX = Math.round(W * 2 * safePct);  // слева/справа суммарно по ширине книги
  const safeY = Math.round(H * safePct);      // сверху/снизу

  // применяем CSS-переменные
  const root = document.documentElement;
  root.style.setProperty('--page-w', W + 'px');
  root.style.setProperty('--page-h', H + 'px');
  root.style.setProperty('--safe-x', safeX + 'px');
  root.style.setProperty('--safe-y', safeY + 'px');

  // на всякий: убираем скроллы у окна
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';

  // Инициализация PageFlip
  const el = document.getElementById('book');
  const flipTime = Math.max(100, parseInt(must('flipTime', 800), 10));
  const showHint = (must('showHint','false') === 'true');

  const pageFlip = new St.PageFlip(el, {
    width: W,
    height: H,
    size: 'fixed',
    minWidth: W,
    maxWidth: W,
    minHeight: H,
    maxHeight: H,
    drawShadow: true,
    flippingTime: flipTime,
    clickEventForward: true,
    showPageCorners: true,
    useMouseEvents: true,
    startZIndex: 3
  });

  // создаём пустые элементы под изображения
  const pages = imgs.map(() => {
    const p = document.createElement('div');
    p.className = 'page-holder';
    p.style.width = W+'px';
    p.style.height = H+'px';
    return p;
  });

  pageFlip.loadFromHTML(pages);

  // подставляем фоны (cover = первая строка)
  pageFlip.on('init', () => {
    const items = el.querySelectorAll('.stf__item .stf__item_page');
    items.forEach((node, i) => {
      node.style.background = `url('${imgs[i]||imgs[imgs.length-1]}') center center / cover no-repeat`;
    });
  });

  // подсказки перелистывания
  if(showHint){
    const stage = document.getElementById('stage');
    stage.title = 'Клик/тач слева или справа — перелистывание';
  }

  // «Приоткрывание» обложки — просто декоративное (без автоперелистывания)
  // делаем легкий наклон левой половины (над книгой прозрачный див)
  // При клике — норм перелист.
})();
</script>
</body>
</html>
