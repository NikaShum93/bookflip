<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Живая книга</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<style>
  /* полная прозрачность, без скроллов */
  html,body{margin:0;height:100%;background:transparent;overflow:hidden}

  /* сцена — только для центрирования и масштабирования */
  .scene{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:transparent; overflow:visible;
    touch-action:none; /* важно для Genially */
  }

  /* рамка разворота: строго 2w × h, тени НЕ вешаем сюда */
  .book-frame{
    position:relative; background:transparent; overflow:visible;
    transform-origin:center center; will-change:transform;
  }

  /* сам виджет */
  #book{width:100%;height:100%;background:transparent}
  .stf__wrapper,.stf__block{overflow:visible!important}

  /* страница-носитель: изображение + декоративные слои живут на самой странице */
  .page{position:relative;width:100%;height:100%;background:transparent}
  .page img{
    width:100%; height:100%; object-fit:contain; display:block;
    background:transparent; border:none; border-radius:0; box-shadow:none; outline:none;
    user-select:none; -webkit-user-drag:none; pointer-events:none;
  }

  /* объём бумаги + виньетка (сидит на странице, НЕ расширяет кликабельную область) */
  :root{ --edge:14px; }
  .stf__page{
    background:transparent!important; overflow:visible!important;
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.08),    /* тонкая «кромка» бумаги */
      0 6px 14px rgba(0,0,0,.22);         /* лёгкий объём самой страницы */
  }
  .stf__page::after{
    content:""; position:absolute; inset:0; pointer-events:none; z-index:2; mix-blend-mode:multiply;
    background:
      radial-gradient(110% 95% at 50% 50%, rgba(0,0,0,.16) 0%, rgba(0,0,0,0) 60%),
      linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,0) 18%, rgba(0,0,0,0) 82%, rgba(0,0,0,.06));
  }
  /* внешняя кромка каждой страницы */
  .stf__page::before{
    content:""; position:absolute; top:0; bottom:0; width:var(--edge); pointer-events:none; z-index:2; opacity:.5;
  }
  .stf__item--left  .stf__page::before{ right:0; background:linear-gradient(90deg,  rgba(0,0,0,.26), rgba(0,0,0,0)) }
  .stf__item--right .stf__page::before{ left:0;  background:linear-gradient(270deg, rgba(0,0,0,.26), rgba(0,0,0,0)) }

  /* корешок (глубина в развороте) */
  .stf__item--left::before, .stf__item--right::before{
    content:""; position:absolute; top:0; bottom:0; width:3.2%;
    pointer-events:none; z-index:1; mix-blend-mode:multiply; opacity:.55;
  }
  .stf__item--left::before  { right:0; background:linear-gradient(90deg,  rgba(0,0,0,.70), rgba(0,0,0,0)) }
  .stf__item--right::before { left:0;  background:linear-gradient(270deg, rgba(0,0,0,.70), rgba(0,0,0,0)) }

  /* когда видна только обложка/задник — корешковые тени скрываем */
  .single .stf__item::before{ display:none }

  /* лёгко «подогнутые» уголки (перспектива, очень деликатно) */
  .stf__page{ transform-style:preserve-3d }
  .stf__page > *{ transform:translateZ(0.01px) } /* микрорельеф без артефактов */
</style>
</head>
<body>
  <div id="scene" class="scene">
    <div id="frame" class="book-frame">
      <div id="book"></div>
    </div>
  </div>

  <audio id="flipSound" preload="auto" src="https://raw.githubusercontent.com/NikaShum93/bookflip/main/flip.mp3"></audio>
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
  <script>
  (function(){
    const qs = new URLSearchParams(location.search);

    /* терпеливое раскодирование (Genially часто дабл-энкодит) */
    function safeDecode(u){
      let a=u, b=u;
      for(let i=0;i<3;i++){ try{ b=decodeURIComponent(a); }catch(e){ break; } if(b===a) break; a=b; }
      return b;
    }
    const urls = (qs.get('imgs')||'')
      .split(/[|,]/).map(s=>safeDecode(s.trim())).filter(Boolean);
    if(!urls.length) return;

    const flipTime = +qs.get('flipTime')>0 ? +qs.get('flipTime') : 800;
    const pageW = parseInt(qs.get('w'),10)||600;
    const pageH = parseInt(qs.get('h'),10)||900;

    const scene = document.getElementById('scene');
    const frame = document.getElementById('frame');
    const book  = document.getElementById('book');

    /* размеры книги (2w×h) и безопасный прозрачный «воздух» за счёт масштаба */
    frame.style.width  = (pageW*2)+'px';
    frame.style.height =  pageH    +'px';
    frame.style.setProperty('--edge', Math.max(10, Math.min(22, Math.round(pageW*0.02)))+'px');

    const safeX = 0.15, safeY = 0.20;  // 15% по ширине, 20% по высоте — чтобы волна не резалась
    function fit(){
      const needW=(pageW*2)*(1+safeX*2), needH=pageH*(1+safeY*2);
      const s=Math.min(scene.clientWidth/needW, scene.clientHeight/needH);
      frame.style.transform='scale('+s+')';
    }
    addEventListener('resize', fit, {passive:true}); fit();

    /* строго горизонтальный разворот; тач-скролл у плагина выключаем — это критично для Genially */
    const pf = new St.PageFlip(book,{
      width:pageW, height:pageH, size:'fixed', autoSize:false,
      usePortrait:false, showCover:true,
      flippingTime:flipTime, drawShadow:true, maxShadowOpacity:.9,
      mobileScrollSupport:false,   /* <— вот это решает проблему кликов в Genially */
      showHint:false
    });

    /* создаём HTML-страницы (обложка/задник — жёсткие) */
    const host=document.createElement('div');
    urls.forEach((src,i)=>{
      const p=document.createElement('div'); p.className='page';
      p.setAttribute('data-density',(i===0||i===urls.length-1)?'hard':'soft');
      const img=document.createElement('img'); img.src=src; img.alt='';
      p.appendChild(img); host.appendChild(p);
    });
    const nodes=host.querySelectorAll('.page');
    if(typeof pf.loadFromHTML==='function') pf.loadFromHTML(nodes); else pf.loadFromImages(urls);

    /* звук и переключение класса .single (убираем корешок на обложке/заднике) */
    const flipSound=document.getElementById('flipSound');
    function syncSingle(){
      const i=pf.getCurrentPageIndex();
      frame.classList.toggle('single', (i===0 || i===urls.length-1));
    }
    pf.on('flip', ()=>{ try{ flipSound.currentTime=0; flipSound.play(); }catch(_){} syncSingle(); });
    syncSingle();

    /* управление кликом/клавишами; есть «лок» от двойного клика */
    let lock=false;
    function safeFlip(dir){
      if(lock || pf.isFlipping()) return;
      lock=true;
      (dir==='prev'?pf.flipPrev:pf.flipNext).call(pf,'top');
      setTimeout(()=>lock=false, pf.getSettings().flippingTime+40);
    }
    frame.addEventListener('click', e=>{
      const r=frame.getBoundingClientRect();
      safeFlip( (e.clientX-r.left) < r.width/2 ? 'prev' : 'next' );
    }, {passive:true});
    addEventListener('keydown', e=>{
      if(e.key==='ArrowLeft')  safeFlip('prev');
      if(e.key==='ArrowRight') safeFlip('next');
    });

    /* лёгкое приоткрытие обложки при наведении (десктоп; безопасно для кликов) */
    if (matchMedia('(hover:hover) and (pointer:fine)').matches){
      let tease=false, t1=0, t2=0;
      const TEASE=Math.max(300,Math.min(600,Math.round(flipTime*0.6)));
      const setT=t=>{ try{ pf.getSettings().flippingTime=t; }catch(_){} };
      frame.addEventListener('mouseenter', ()=>{
        if (pf.isFlipping() || tease || pf.getCurrentPageIndex()!==0) return;
        tease=true; const old=pf.getSettings().flippingTime; setT(TEASE);
        pf.flipNext('top');
        t1=setTimeout(()=>{ pf.flipPrev('top'); t2=setTimeout(()=>{ setT(old); tease=false; syncSingle(); }, TEASE+40); }, Math.floor(TEASE*0.38));
      });
      frame.addEventListener('mouseleave', ()=>{ if(t1)clearTimeout(t1); if(t2)clearTimeout(t2); tease=false; });
    }
  })();
  </script>
</body>
</html>
