<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Живая книга</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<style>
  :root{
    --page-w:600px;           /* подменится из query */
    --page-h:900px;           /* подменится из query */
    --safe:0.12;              /* прозрачный запас вокруг книги (доли от высоты) */
    --gutter:28px;            /* визуальная толщина корешка/зазора */
    --shadow:22px;            /* сила «настольной» тени */
  }
  html,body{height:100%;margin:0;background:transparent}
  .stage{
    /* прозрачная «сцена» даёт место для анимации — ничего не обрезается */
    position:fixed; inset:0; display:grid; place-items:center;
    background:transparent; overflow:visible;
  }
  .book-wrap{
    position:relative;
    width:calc(var(--page-w)*2);
    height:var(--page-h);
    /* прозрачная подушка вокруг книги; *тут* нет цвета, поэтому Genially видит прозрачность */
    padding:calc(var(--safe) * var(--page-h)) calc(var(--safe) * var(--page-h));
    box-sizing:content-box;
    overflow:visible;
    pointer-events:auto;
  }

  /* реальная книга */
  #book{ width:calc(var(--page-w)*2); height:var(--page-h); overflow:visible; }

  /* «настольная» тень ПОД книгой — всегда под центром */
  .table-shadow{
    position:absolute; left:50%; top:50%;
    translate:-50% -50%;
    width:calc(var(--page-w)*2 * 0.86);
    height:calc(var(--page-h) * 0.14);
    filter:blur(var(--shadow));
    opacity:.55;
    pointer-events:none;
    z-index:0;
    background:
      radial-gradient(120% 100% at 50% 50%, rgba(0,0,0,.35), rgba(0,0,0,0) 70%);
    /* если книга закрыта и одна обложка — подтянем ближе */
    transition:opacity .2s ease, transform .2s ease;
  }

  /* внутренняя «виньетка» по краям каждой страницы (объём) */
  .stf__item{ position:relative; overflow:visible; }
  .stf__item::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    box-shadow:
      inset 0 0 48px rgba(0,0,0,.18),   /* по краям страниц */
      inset 14px 0 28px rgba(0,0,0,.15),/* левый край */
      inset -14px 0 28px rgba(0,0,0,.15);/* правый край */
    border-radius:3px;
  }

  /* мягкая вертикальная тень в корешке — строго над книгой, не выходит наружу */
  .gutter-shadow{
    position:absolute; left:50%; top:calc(var(--safe) * var(--page-h));
    width:var(--gutter);
    height:var(--page-h);
    translate:-50% 0;
    pointer-events:none; z-index:2;
    background:linear-gradient(90deg,
      rgba(0,0,0,0) 0%,
      rgba(0,0,0,.22) 50%,
      rgba(0,0,0,0) 100%);
    filter:blur(6px);
    opacity:.65;
  }
  /* если показываем только обложку (первая страница слева пустая) — корешковую тень прячем */
  .only-cover .gutter-shadow{ opacity:0; }

  /* убираем скругления — как просила */
  .stf__item canvas{ border-radius:0 !important; }
</style>
</head>
<body>

<div class="stage">
  <div class="book-wrap" id="wrap">
    <div class="table-shadow" id="tableShadow"></div>
    <div class="gutter-shadow" id="gutter"></div>
    <div id="book"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
<script>
(function(){
  /** утилиты **/
  const qsRaw = location.search.replace(/^\?/, '');
  const params = new URLSearchParams(qsRaw.replace(/&amp;/g,'&'));

  function num(v, d){ v = parseFloat(String(v).replace(',', '.')); return Number.isFinite(v)?v:d; }

  function normalizeImgs(qsValue){
    if(!qsValue) return [];
    // 1) вернём «|» вместо %7C/%257C
    let s = qsValue.replace(/%257C/gi,'|').replace(/%7C/gi,'|');
    // 2) иногда весь блок дважды кодирован — попробуем снять кодировку до 2 раз
    try{
      const once = decodeURIComponent(s);
      if(/https?:\/\//i.test(once)) s = once;
      const twice = decodeURIComponent(once);
      if(/https?:\/\//i.test(twice)) s = twice;
    }catch(e){}
    // 3) split и финальная чистка
    return s.split('|')
      .map(u=>u.trim())
      .filter(Boolean)
      .map(u=>{
        // уберём случайные двойные кодировки в каждом URL
        try{
          const dec1 = decodeURIComponent(u);
          if(/^https?:\/\//i.test(dec1)) return dec1;
        }catch(e){}
        return u;
      });
  }

  /** читаем параметры **/
  const W = num(params.get('w'), 600);
  const H = num(params.get('h'), 900);
  const flipTime = Math.max(100, num(params.get('flipTime'), 800));
  const showHint = String(params.get('showHint')).toLowerCase() === 'true';
  const safe = Math.min(.35, Math.max(0, num(params.get('safe'), .12)));
  const imgs = normalizeImgs(params.get('imgs'));

  if(!imgs.length){
    document.body.innerHTML =
      '<div style="position:fixed;inset:0;display:grid;place-items:center;color:#fff;background:#333a;text-align:center;padding:20px;border-radius:12px;">' +
      '<div style="background:#000c;padding:12px 16px;border-radius:12px;">Пустой imgs — нет изображений.</div>' +
      '</div>';
    return;
  }

  /** применим размеры и safe-пэддинг в CSS-переменные **/
  const root = document.documentElement.style;
  root.setProperty('--page-w', W + 'px');
  root.setProperty('--page-h', H + 'px');
  root.setProperty('--safe', safe + '');

  /** инициализация PageFlip **/
  const bookEl = document.getElementById('book');
  const wrapEl = document.getElementById('wrap');
  const tableShadow = document.getElementById('tableShadow');

  // контент
  const pages = imgs.map(url => ({ type: 'image', src: url }));

  const pf = new St.PageFlip(bookEl, {
    width: W,
    height: H,
    size: 'fixed',
    useMouseEvents: true,
    showCover: true,              // обложка как отдельная страница
    mobileScrollSupport: false,
    maxShadowOpacity: 0.35,
    flippingTime: flipTime,
    startZIndex: 3,
    drawShadow: true
  });

  pf.loadFromImages(imgs);

  // подсказки (по желанию)
  if (showHint) {
    wrapEl.style.cursor = 'pointer';
  }

  // когда на первой странице — прячем тень корешка, оставляем «настольную»
  function updateShadows(){
    const state = pf.getState();
    const onlyCover = (state.page === 0 && state.mode === 'portrait'); // в нашем «fixed» — валидно для обложки
    wrapEl.classList.toggle('only-cover', onlyCover);
    // подложка-тень всегда под книгой, но можно слегка подвинуть при обложке, чтобы «ближе» выглядело
    tableShadow.style.transform = onlyCover ? 'translate(-50%,-46%)' : 'translate(-50%,-50%)';
  }
  pf.on('flip', updateShadows);
  pf.on('init', updateShadows);

  // защита от обрезаний: сцена прозрачная, overflow видим; ничего больше не нужно.
})();
</script>
</body>
</html>
