<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Teachy Witchy — Живая книга</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">

<style>
  :root{
    /* геометрия / клип */
    --padX: 0px;            /* задаём из JS как % от ширины страницы */
    --padY: 0px;            /* …и высоты */
    --clipTop: -22%;        /* расширяем клип вверх… */
    --clipBottom: -22%;     /* …и вниз, чтобы волна/обложка не резались */
    --cornerR: 10px;

    /* объём / тени */
    --spineAlpha: .32;      /* глубина корешка */
    --sheetDrop: .22;       /* тень от листа наружу */
  }

  html,body{height:100%;margin:0;background:transparent}

  /* Внешняя «рамка» книги с дополнительным пространством для анимации */
  .book-frame{
    position:relative;
    width: var(--frameW);
    height: var(--frameH);
    margin:0 auto;
    background:transparent;
  }
  /* тень «книга на столе» — отключается для одиночной обложки */
  .book-frame::after{
    content:"";
    position:absolute; left:5%; right:5%; bottom:-18px; height:40px;
    background:
      radial-gradient(70% 140% at 50% -10%, rgba(0,0,0,.28) 0, rgba(0,0,0,.18) 45%, rgba(0,0,0,0) 80%),
      linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.18) 12%, rgba(0,0,0,.18) 88%, rgba(0,0,0,0) 100%);
    filter: blur(10px);
    pointer-events:none; z-index:0;
  }
  .book-frame.single::after{display:none;}

  /* Сам «клип» книги. Стороны по X не обрезаем, по Y расширяем отрицательным inset */
  .book-clip{
    position:absolute; top:var(--padY); left:var(--padX);
    width:var(--bookW); height:var(--bookH);
    overflow:visible;
    clip-path: inset(var(--clipTop) 0 var(--clipBottom) 0 round 6px);
  }

  /* контейнер PageFlip */
  #flip{
    width:100%; height:100%;
    background:transparent !important;
  }

  /* страница */
  .stf__page{
    background:transparent !important;
    overflow:visible !important;
    border-radius:var(--cornerR);
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.08),
      0 14px 22px rgba(0,0,0,var(--sheetDrop));
    will-change:transform;
  }
  /* твёрдые (обложки) плотнее */
  [data-density="hard"].stf__page{
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.12),
      0 18px 28px rgba(0,0,0,.22);
  }

  /* внутренняя виньетка + «уголки» */
  .stf__page::after{
    content:""; position:absolute; inset:0; border-radius:var(--cornerR);
    pointer-events:none; z-index:2; mix-blend-mode:multiply;
    background:
      radial-gradient(115% 95%  at 50% 50%, rgba(0,0,0,.18) 0%, rgba(0,0,0,0) 62%),
      linear-gradient(to bottom, rgba(0,0,0,.16), rgba(0,0,0,0) 18%, rgba(0,0,0,0) 82%, rgba(0,0,0,.16)),
      radial-gradient(120% 120% at 0% 0%,     rgba(0,0,0,.22) 0%, rgba(0,0,0,0) 66%),
      radial-gradient(120% 120% at 100% 100%, rgba(0,0,0,.22) 0%, rgba(0,0,0,0) 66%);
    background-repeat:no-repeat;
    background-size:100% 100%, 100% 100%, 20% 20%, 20% 20%;
    background-position:center, center, left top, right bottom;
  }

  /* корешок внутри разворота */
  .stf__book{
    position:relative;
  }
  .stf__book::before{
    content:""; position:absolute; top:0; bottom:0; left:50%; width:20%;
    transform:translateX(-50%);
    pointer-events:none; z-index:0;
    background:
      radial-gradient(80% 100% at 50% 50%, rgba(0,0,0,var(--spineAlpha)) 0%, rgba(0,0,0,0) 66%);
    filter:blur(6px);
  }

  /* наружные кромки страниц (чуть темнее) */
  .stf__item--left::before,
  .stf__item--right::before{
    content:""; position:absolute; top:0; bottom:0; width:4%;
    pointer-events:none; mix-blend-mode:multiply; opacity:.6; z-index:1;
  }
  .stf__item--left::before { right:0; background:linear-gradient(90deg, rgba(0,0,0,.75), rgba(0,0,0,0)); }
  .stf__item--right::before{ left:0;  background:linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,.75)); }

  /* лёгкий «приподнять обложку» при ховере на закрытой книге */
  .peek .stf__item--hard.stf__item--left .stf__page{
    transform: perspective(1200px) rotateY(-6deg) translateX(-1px);
    transition: transform .25s ease;
  }

  /* изображения-страницы */
  .pf-img{
    width:100%; height:100%; object-fit:cover; display:block; border-radius:var(--cornerR);
    background:#0000;
  }
</style>
</head>
<body>

<div id="root"></div>

<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
<script>
(function(){
  const qs = new URLSearchParams(location.search);

  // -------- параметры из редактора --------
  const w = +qs.get('w') || 600;            // ширина ОДНОЙ страницы
  const h = +qs.get('h') || 900;            // высота страницы
  const flipTime = +qs.get('flipTime') || 800;
  const showHint = (qs.get('showHint')||'false') === 'true';

  const imgs = (qs.get('imgs')||'').split('|')
                .map(s => s ? decodeURIComponent(s) : s)
                .filter(Boolean);

  if (!imgs.length){
    toast('Пустой imgs — нет изображений.');
    return;
  }

  // -------- защитное пространство вокруг книги --------
  const padX = Math.round(w * 0.22);
  const padY = Math.round(h * 0.32);

  const frameW = (w*2 + padX*2) + 'px';
  const frameH = (h   + padY*2) + 'px';
  const bookW  = (w*2) + 'px';
  const bookH  = h + 'px';

  document.documentElement.style.setProperty('--padX', padX+'px');
  document.documentElement.style.setProperty('--padY', padY+'px');
  document.documentElement.style.setProperty('--bookW', bookW);
  document.documentElement.style.setProperty('--bookH', bookH);
  document.documentElement.style.setProperty('--frameW', frameW);
  document.documentElement.style.setProperty('--frameH', frameH);

  // -------- DOM --------
  const frame = document.createElement('div');
  frame.className = 'book-frame';
  const clip = document.createElement('div');
  clip.className = 'book-clip';
  const flipEl = document.createElement('div');
  flipEl.id = 'flip';
  clip.appendChild(flipEl);
  frame.appendChild(clip);
  document.getElementById('root').appendChild(frame);

  // -------- PageFlip init --------
  const pf = new St.PageFlip(flipEl, {
    width: w,
    height: h,
    size: 'fixed',
    usePortrait: false,
    showCover: true,
    maxShadowOpacity: 0,   // свои тени рисуем CSS-ом
    drawShadow: false,
    flippingTime: flipTime,
    startZIndex: 5,
    autoSize: false,
    mobileScrollSupport: false,
  });

  // обложка
  const coverNode = makePage(imgs[0], true);
  // внутренние страницы
  const innerNodes = imgs.slice(1).map(url => makePage(url, false));

  // загрузка
  pf.loadFromHTML([coverNode, ...innerNodes]);

  // подсказки клика (стрелочки) — по желанию
  if (showHint) addHints(frame);

  // одиночная обложка — убираем тень-подложку
  updateSingleClass();
  pf.on('flip', updateSingleClass);
  function updateSingleClass(){
    const idx = pf.getCurrentPageIndex();
    frame.classList.toggle('single', idx === 0);
  }

  // «приоткрыть» обложку на ховер, только когда закрыта
  let hovering = false;
  frame.addEventListener('mouseenter', ()=>{ if (pf.getCurrentPageIndex()===0){ hovering=true; clip.classList.add('peek'); }});
  frame.addEventListener('mouseleave', ()=>{ hovering=false; clip.classList.remove('peek'); });
  pf.on('flip', ()=>{ if (!hovering) clip.classList.remove('peek'); });

  // служебные
  function makePage(url, hard=false){
    const page = document.createElement('div');
    page.className = 'page';
    page.setAttribute('data-density', hard ? 'hard' : 'soft');

    const img = document.createElement('img');
    img.className = 'pf-img';
    img.src = url;
    img.loading = 'eager';
    page.appendChild(img);
    return page;
  }

  function addHints(host){
    const left = document.createElement('div');
    left.style.cssText = 'position:absolute;left:6px;top:50%;transform:translateY(-50%);font:700 22px/1 system-ui;opacity:.45;user-select:none;pointer-events:none;';
    left.textContent = '◀';
    const right = left.cloneNode(true);
    right.style.left = 'unset'; right.style.right = '6px'; right.textContent = '▶';
    host.append(left,right);
  }

  function toast(msg){
    const b = document.createElement('div');
    b.textContent = msg;
    b.style.cssText = 'position:fixed;inset:auto auto 20px 50%;transform:translateX(-50%);background:#111; color:#e7eef7; padding:10px 14px;border-radius:12px;font:14px/1.2 system-ui; z-index:9999';
    document.body.appendChild(b);
    setTimeout(()=>b.remove(), 2800);
  }
})();
</script>
</body>
</html>
