<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Teachy Witchy — Живая книга</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css">
<style>
  :root{
    /* доп-пространство вокруг книги (ставлю из JS) */
    --padX: 0px;
    --padY: 0px;

    /* расширяем область клипа во ВСЕ СТОРОНЫ, чтобы волна/обложка не резались */
    --clipTop: -38%;
    --clipRight: -34%;
    --clipBottom: -38%;
    --clipLeft: -34%;

    /* оптика */
    --spineAlpha: .42;     /* глубина у корешка */
    --edgeVign: .85;       /* затемнение у внешних кромок */
    --sheetDrop: .26;      /* тень от листа наружу */
  }

  html,body{height:100%;margin:0;background:transparent;overflow:hidden}

  /* Рама с прозрачным полем по периметру */
  .book-frame{
    position:relative;
    width: var(--frameW);
    height: var(--frameH);
    margin:0 auto;
    background:transparent;
  }

  /* Блок, который держит саму книгу; тут же рисуем «столовую» тень ПОД книгой */
  .book-clip{
    position:absolute;
    left:var(--padX); top:var(--padY);
    width:var(--bookW); height:var(--bookH);
    overflow:visible;           /* ничего не резать */
    clip-path: inset(var(--clipTop) var(--clipRight) var(--clipBottom) var(--clipLeft));
  }
  /* Тень «книга лежит на столе»: прямо под книгой, со всех сторон */
  .book-clip::after{
    content:"";
    position:absolute; left:-6%; width:112%;
    bottom:-10px; height:46px;
    background:
      radial-gradient(60% 100% at 50% 0,
        rgba(0,0,0,.42) 0, rgba(0,0,0,.25) 55%, rgba(0,0,0,0) 100%),
      radial-gradient(120% 30% at 50% 100%,
        rgba(0,0,0,.20) 0, rgba(0,0,0,0) 80%);
    filter: blur(10px);
    pointer-events:none; z-index:0;
  }

  #flip{width:100%;height:100%;background:transparent!important}

  /* страница — БЕЗ скруглений, объём рисуем виньетками */
  .stf__page{
    background:transparent!important;
    overflow:visible!important;
    border-radius:0;
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.06),
      0 14px 22px rgba(0,0,0,var(--sheetDrop));
    will-change:transform;
  }
  [data-density="hard"].stf__page{
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.10),
      0 18px 28px rgba(0,0,0,.24);
  }

  /* Внутренние виньетки и «уголки» (визуальные, без скругления геометрии) */
  .stf__page::after{
    content:""; position:absolute; inset:0; pointer-events:none; z-index:2; mix-blend-mode:multiply;
    background:
      /* мягкая центральная виньетка для объёма */
      radial-gradient(115% 95% at 50% 50%, rgba(0,0,0,.22) 0, rgba(0,0,0,0) 60%),
      /* чуть темнее у верх/низ кромок */
      linear-gradient(to bottom, rgba(0,0,0,.18), rgba(0,0,0,0) 18%, rgba(0,0,0,0) 82%, rgba(0,0,0,.18)),
      /* уголковые акценты (но без реального скругления) */
      radial-gradient(110% 110% at 0% 0%,     rgba(0,0,0,.30) 0, rgba(0,0,0,0) 66%),
      radial-gradient(110% 110% at 100% 0%,   rgba(0,0,0,.24) 0, rgba(0,0,0,0) 66%),
      radial-gradient(110% 110% at 0% 100%,   rgba(0,0,0,.24) 0, rgba(0,0,0,0) 66%),
      radial-gradient(110% 110% at 100% 100%, rgba(0,0,0,.30) 0, rgba(0,0,0,0) 66%);
    background-repeat:no-repeat;
  }

  /* тёмная «борозда» корешка ЧИСТО внутри книги */
  .stf__book{position:relative}
  .stf__book::before{
    content:""; position:absolute; inset:0; pointer-events:none; z-index:0;
    background:
      radial-gradient(90% 110% at 50% 50%,
        rgba(0,0,0,var(--spineAlpha)) 0, rgba(0,0,0,0) 68%);
    mask: linear-gradient(90deg, transparent 0 45%, #000 50%, transparent 55% 100%);
    filter: blur(8px);
  }

  /* внешние кромки страниц */
  .stf__item--left::before,
  .stf__item--right::before{
    content:""; position:absolute; top:0; bottom:0; width:7%;
    pointer-events:none; mix-blend-mode:multiply; opacity:var(--edgeVign); z-index:1;
  }
  .stf__item--left::before { right:0; background:linear-gradient(90deg, rgba(0,0,0,.85), rgba(0,0,0,0)); }
  .stf__item--right::before{ left:0;  background:linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,.85)); }

  /* лёгкое «приоткрывание» обложки при ховере (корешок неподвижен) */
  .peek .stf__item--hard.stf__item--left .stf__page{
    transform: perspective(1200px) rotateY(-6deg) translateX(-1px);
    transition: transform .22s ease;
  }

  /* сами картинки-страницы */
  .pf-img{width:100%;height:100%;display:block;object-fit:cover;background:#0000}
</style>
</head>
<body>
<div id="root"></div>

<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
<script>
(function(){
  const qs = new URLSearchParams(location.search);

  const w = +qs.get('w') || 600;   // ширина одной страницы
  const h = +qs.get('h') || 900;   // высота
  const flipTime = +qs.get('flipTime') || 800;
  const showHint = (qs.get('showHint')||'false') === 'true';

  const imgs = (qs.get('imgs')||'').split('|').map(s=>s?decodeURIComponent(s):s).filter(Boolean);
  if(!imgs.length){return toast('Пустой imgs — нет изображений.');}

  /* большое прозрачное поле по периметру для анимации */
  const padX = Math.round(w * 0.30);
  const padY = Math.round(h * 0.42);

  const frameW = (w*2 + padX*2) + 'px';
  const frameH = (h   + padY*2) + 'px';
  const bookW  = (w*2) + 'px';
  const bookH  = h + 'px';

  const r = document.documentElement.style;
  r.setProperty('--padX', padX+'px');
  r.setProperty('--padY', padY+'px');
  r.setProperty('--frameW', frameW);
  r.setProperty('--frameH', frameH);
  r.setProperty('--bookW', bookW);
  r.setProperty('--bookH', bookH);

  const frame = el('div','book-frame');
  const clip  = el('div','book-clip');
  const flipEl= el('div'); flipEl.id='flip';
  clip.appendChild(flipEl); frame.appendChild(clip); byId('root').appendChild(frame);

  const pf = new St.PageFlip(flipEl,{
    width:w,height:h,size:'fixed',
    usePortrait:false, showCover:true,
    drawShadow:false, maxShadowOpacity:0,
    flippingTime:flipTime,
    autoSize:false, mobileScrollSupport:false,
    startZIndex:5
  });

  pf.loadFromHTML([page(imgs[0], true), ...imgs.slice(1).map(u=>page(u,false))]);

  // подсказки по желанию
  if (showHint) hint(frame);

  // hover-приоткрытие только когда на обложке
  let hovering=false;
  frame.addEventListener('mouseenter',()=>{ if(pf.getCurrentPageIndex()===0){ hovering=true; clip.classList.add('peek'); }});
  frame.addEventListener('mouseleave',()=>{ hovering=false; clip.classList.remove('peek'); });
  pf.on('flip',()=>{ if(!hovering) clip.classList.remove('peek'); });

  /* helpers */
  function page(url, hard){
    const p=el('div'); p.setAttribute('data-density', hard?'hard':'soft');
    const img=new Image(); img.className='pf-img'; img.decoding='sync'; img.loading='eager'; img.src=url;
    p.appendChild(img); return p;
  }
  function el(tag,cls){const n=document.createElement(tag); if(cls) n.className=cls; return n;}
  function byId(id){return document.getElementById(id);}
  function hint(host){
    const L=el('div'),R=el('div');
    Object.assign(L.style,{position:'absolute',left:'6px',top:'50%',transform:'translateY(-50%)',font:'800 22px/1 system-ui',opacity:'.45',pointerEvents:'none'});
    Object.assign(R.style,L.style); R.style.left='unset'; R.style.right='6px'; L.textContent='◀'; R.textContent='▶';
    host.append(L,R);
  }
  function toast(t){
    const b=el('div'); b.textContent=t;
    b.style.cssText='position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#e7eef7;padding:10px 14px;border-radius:12px;font:14px/1.2 system-ui;z-index:9999';
    document.body.appendChild(b); setTimeout(()=>b.remove(),2600);
  }
})();
</script>
</body>
</html>
